<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Motivation</title>

    <link rel="stylesheet" href="/metrium/WebResources/mtr_FWK/Styles/kendo.common.min.css">
    <link rel="stylesheet" href="/metrium/WebResources/mtr_FWK/Styles/kendo.silver.min.css">

    <script type="text/javascript" src="ClientGlobalContext.js.aspx"></script>
    <script type="text/javascript" src="/metrium/WebResources/mtr_FWK/jquery.min.js"></script>
    <script type="text/javascript" src="/metrium/WebResources/mtr_FWK/kendo.all.min.js"></script>
    <script type="text/javascript" src="/metrium/WebResources/mtr_FWK/kendo.culture.ruRU.min.js"></script>
    <script type="text/javascript" src="/metrium/WebResources/mtr_FWK/json2.js"></script>
    <script type="text/javascript" src="/metrium/WebResources/mtr_FWK/FileSaver.js"></script>

    <script type="text/javascript">
        function FixSize() {
            var currentHght = (window.innerHeight == null) ? document.documentElement.clientHeight : window.innerHeight;

            if (document.getElementById("vertical") != null)
                document.getElementById("vertical").style.height = (currentHght != null) ? (currentHght - 2) + "px" : "99.7%";

            document.body.style.height = (currentHght != null) ? (currentHght - 2) + "px" : "99.7%";

            ResizeSplitter();
        }
        function _getServerUrl() {

            var docLocation = window.parent.document.location;

            var gloContext = null;

            try { gloContext = GetGlobalContext(); }
            catch (err) { }

            return docLocation.protocol + '//' + docLocation.host + '/' + ((gloContext) ? gloContext.getOrgUniqueName() : 'metrium');
        }
        function _isUserMaster() {
            var gloContext = null;

            try { gloContext = GetGlobalContext(); }
            catch (err) { }

            var userRoles = gloContext.getUserRoles();

            var findFlag = false; //(userRoles && userRoles.length &&
            //~userRoles.indexOf('87f65b15-6389-e311-8467-00155d58232a')); // кровь из глаз

            return (findFlag) ? '' : gloContext.getUserId();
        }
        function _dateReviver(key, value) {
            var a;
            if (typeof value === 'string') {
                a = /Date\(([-+]?\d+)\)/.exec(value);

                if (a)
                    return new Date(parseInt(value.replace("/Date(", "").replace(")/", ""), 10));
            }
            return value;
        }
        function _suburlCRMSvc() {
            return '/XRMServices/2011/OrganizationData.svc/';
        }
        function _checkAjaxUrl(requestUrl) {
            /// <summary> Проверка и "исправление" ссылки для многостраничного запроса </summary>
            var currSrvUrl = _getServerUrl();

            if (~requestUrl.indexOf(currSrvUrl)) return requestUrl;

            var corpSrvUrl = '';

            try {
                var gloContext = GetGlobalContext();
                corpSrvUrl = gloContext.getServerUrl();
            }
            catch (err) { }

            if (corpSrvUrl != '' && ~requestUrl.indexOf(corpSrvUrl)) return requestUrl.replace(corpSrvUrl, currSrvUrl);
            else {
                var subCrmUrl = _suburlCRMSvc();

                if (~requestUrl.indexOf(subCrmUrl)) return currSrvUrl + requestUrl.substring(requestUrl.indexOf(subCrmUrl));
                else return requestUrl;
            }
        }
        function _pathForAjax(entName, serverUrl) {
            if (typeof serverUrl == 'undefined' || serverUrl == null || serverUrl == '') serverUrl = _getServerUrl();

            return serverUrl + _suburlCRMSvc() + entName + 'Set';
        }
        function _asyncReqst(requestUrl, successMethd) {
            /// <summary> Выполнение синхронного запроса </summary>
            $.ajax({
                type: 'GET',
                contentType: "application/json; charset=utf-8",
                datatype: "json",
                async: true,
                url: requestUrl,
                success: successMethd,
                beforeSend: function (XMLHttpRequest) { XMLHttpRequest.setRequestHeader("Accept", "application/json"); }
            });
        }
        function _syncRetrieve(serverUrl, entName, selectFlds, fltrString, expandString) {
            /// <summary> Формирование запроса по параметрам </summary>
            return _syncAjaxAlt(_pathForAjax(entName, serverUrl) + "?$select=" + selectFlds + "&$orderby=CreatedOn desc&$filter=" + fltrString +
                    (expandString ? '&$expand=' + expandString : ''));
        }
        function _syncAjaxAlt(requestUrl) {
            /// <summary> Выполнение синхронного запроса </summary>
            var xhr = $.ajax({
                type: "GET",
                contentType: "application/json; charset=utf-8",
                datatype: "json",
                async: false,
                url: requestUrl,
                beforeSend: function (XMLHttpRequest) { XMLHttpRequest.setRequestHeader("Accept", "application/json"); }
            });
            return JSON.parse(xhr.responseText, _dateReviver);
        }
        function _syncAjax(serverUrl, entName, selectFlds, fltrString, expandString) {
            var xhr = $.ajax({
                type: "GET",
                contentType: "application/json; charset=utf-8",
                datatype: "json",
                async: false,
                url: serverUrl + _suburlCRMSvc() + entName + "Set?$select=" + selectFlds + "&$orderby=CreatedOn desc&$filter=" + fltrString +
                    (expandString ? '&$expand=' + expandString : ''),
                beforeSend: function (XMLHttpRequest) { XMLHttpRequest.setRequestHeader("Accept", "application/json"); }
            });
            return JSON.parse(xhr.responseText, _dateReviver);
        }
        function _updateAjax(serverUrl, entName, entUid, updtEntity) {
            var jsonEntity = window.JSON.stringify(updtEntity);
            var xhr = $.ajax({
                type: "POST",
                contentType: "application/json; charset=utf-8",
                datatype: "json",
                data: jsonEntity,
                url: serverUrl + _suburlCRMSvc() + entName + "Set(guid'" + entUid + "')",
                beforeSend: function (XMLHttpRequest) {
                    XMLHttpRequest.setRequestHeader("Accept", "application/json");
                    XMLHttpRequest.setRequestHeader("X-HTTP-Method", "MERGE");
                }
            });
        }
        function _createAjax(serverUrl, entName, crtdEntity) {
            var jsonEntity = window.JSON.stringify(crtdEntity);
            var xhr = $.ajax({
                type: "POST",
                contentType: "application/json; charset=utf-8",
                datatype: "json",
                async: false,
                data: jsonEntity,
                url: serverUrl + _suburlCRMSvc() + entName + "Set",
                beforeSend: function (XMLHttpRequest) { XMLHttpRequest.setRequestHeader("Accept", "application/json"); }
            });
            return JSON.parse(xhr.responseText, _dateReviver);
        }

        function _isArrayFill(currArray) {
            if (typeof currArray == 'undefined' || currArray == null) return false;

            return (currArray.length && currArray.length > 0);
        }

        function _get2DigStr(digValue) {
            return ((digValue < 10) ? '0' : '') + digValue.toString();
        }

        function _snglFltr_DateComp(fltrFld, fltrValue, compOper, isBegin) {
            return fltrFld + " " + compOper + " datetime'" + fltrValue.getFullYear() + '-' + _get2DigStr(fltrValue.getMonth() + 1) + '-' +
                _get2DigStr(fltrValue.getDate()) + 'T' + ((isBegin != null && typeof isBegin != 'undefined') ? (isBegin ? '04:00:00' : '23:59:59') :
                _get2DigStr(fltrValue.getHours()) + ':' + _get2DigStr(fltrValue.getMinutes()) + ':' + _get2DigStr(fltrValue.getSeconds())) + "'";
        }

        function _setOrDefault(setValue, dfltEmpty) {
            return (typeof setValue != 'undefined' && setValue != null) ? setValue : (typeof dfltEmpty != 'undefined') ? dfltEmpty : '';
        }

        function _setMoneyValue(setValue) {
            var retValue = _setOrDefault(setValue, 0);

            return (retValue == 0) ? retValue : (retValue * 100) / 100;
        }

        function JoinNLStrValues(addString, resString) { return ((resString && resString != '') ? resString + '; \n' : '') + addString; }

        function FormatMoneyValue(moneyValue) { return kendo.toString(_setOrDefault(GetParseNum(moneyValue)), 'c'); }

        function setDateFrc(updDate) { return new Date(Date.parse(updDate.toString())); }

        function _getElemById(elementId) { return _getArrayValue($('#' + elementId)); }

        function _getArrayValue(elArray, elIndex) { return (elArray != null && elArray.length > 0) ? elArray[(elIndex != null) ? elIndex : 0] : null; }

        function _snglFltr_GuidEquals(fltrField, fltrValue) { return fltrField + " eq guid'" + fltrValue + "'"; }

        function _snglFltr_OptionComp(fltrField, fltrValue, alterComp) { return fltrField + '/Value' + (alterComp ? " " + alterComp + " " : " eq ") + fltrValue; }

        function _snglFltr_StringEquals(fltrField, fltrValue, isNot) { return fltrField + " " + ((isNot) ? "ne" : "eq") + " '" + fltrValue + "'"; }

        function _snglFltr_NumberCompare(fltrField, fltrValue, alterComp) { return fltrField + (alterComp ? " " + alterComp + " " : " eq ") + fltrValue; }

        function _snglFltr_Substringof(fltrField, fltrValue) { return "substringof('" + fltrValue + "'," + fltrField + ")"; }

        function _snglFltr_BeginsWith(fltrField, fltrValue) { return "startswith(" + fltrField + ",'" + fltrValue + "')"; }

        function _getLookupName(lookupVal) { return (lookupVal && lookupVal.Name) ? lookupVal.Name : ''; }

        function _snglFltr_NotNull(fltrField) { return fltrField + " ne null"; }

        function _getPickValue(pickAttrib, defaultIndx) {
            return (pickAttrib && pickAttrib.Value) ? pickAttrib.Value :
                (pickAttrib && GetParseNum(pickAttrib) != null) ? GetParseNum(pickAttrib) :
                (defaultIndx) ? defaultIndx : -1;
        }

        function GetParseNum(numString) {
            if (numString == '0') return 0;

            var retNum = (numString) ? parseFloat(numString) : null;

            return (retNum && retNum != 'NaN') ? retNum : null;
        }
        function _updateVisibl(elementId, isVisible) {
            var findElement = _getElemById(elementId);

            if (findElement) findElement.style.display = (isVisible) ? "block" : "none";
        }
        function _setTextValue(elementId, elemInnerText) {
            var findElement = _getElemById(elementId);

            if (findElement) findElement.innerText = (elemInnerText) ? elemInnerText : '';
        }
        function _arrayTextByValue(objArray, srchValue, defaultValue) {
            var retText = null;

            if (srchValue && objArray.length > 0)
                for (var step = 0, arLngth = objArray.length; step < arLngth; step++)
                    if (objArray[step] && objArray[step].value && objArray[step].value === srchValue.toString()) {
                        retText = objArray[step].text;
                        break;
                    }

            return (retText) ? retText : defaultValue;
        }
        function _objKeyByValue(srchObject, srchText, defaultValue) {
            var retKey = defaultValue;

            if (srchObject)
                for (var prop in srchObject)
                    if (srchObject[prop] === srchText) {
                        retKey = prop;
                        break;
                    }

            return retKey;
        }
        function _objectUrbSelect(urbObject, prefix) {
            var retSelect = '';

            for (var prop in urbObject)
                if (~prop.indexOf('urb_') && urbObject[prop] != '' && urbObject[prop] != '-self-')
                    retSelect += (retSelect.length > 0 ? ',' : '') + ((prefix) ? prefix : '') + urbObject[prop];

            return retSelect;
        }
        function _objectUrbArray(urbObject) {
            ///<summary> Конвертация объекта в массив, каждый элемент которого - пара: value (название property) - text (значение property)
            ///</summary>
            var retArray = [];

            for (var prop in urbObject) retArray[retArray.length] = { value: prop, text: urbObject[prop] };

            return retArray;
        }
        function _getOption(setValue) { return { Value: setValue }; }
        function _getLookup(recUid, entName, recName) {
            return {
                Id: recUid,
                Name: (recName) ? recName : '',
                LogicalName: entName
            };
        }
        function _getPartyValue(partyAttrib, urbObject) {
            var retString = '';
            var highSet = partyAttrib.split(';');

            for (var step = 0, sLngth = highSet.length; step < sLngth; step++) {
                var stepString = '';
                var chldSet = highSet[step].split(',');

                for (var loop = 0, lLngth = chldSet.length; loop < lLngth; loop++)
                    if (chldSet[loop] in urbObject && stepString == '')
                        stepString = _setOrDefault(urbObject[chldSet[loop]]);

                retString += ((retString.length > 0) ? ' ' : '') + stepString;
            }

            return retString;
        }
        function _revertName(mngrName) {
            var nameArr 
        }
        function _saveCheckVal(fldName, inputValue) {
            return (!(fldName in allRefs.optsAttr)) ? inputValue :
                (inputValue in allRefs[allRefs.optsAttr[fldName]]) ? allRefs[allRefs.optsAttr[fldName]][inputValue] : '';
        }
        function _getCheckVal(fldName, inputText) {
            return (!(fldName in allRefs.optsAttr)) ? inputText : _objKeyByValue(allRefs[allRefs.optsAttr[fldName]], inputText, '');
        }
        function _getActualSPLink(givenLink) {
            return givenLink.replace('//sp1', (~_getServerUrl().indexOf('metrium.ru') ? '//sp.metrium.ru' : '//sp1'));
        }
        window.onresize = FixSize;
    </script>

</head>
<body style="border-width: 0px; padding: 0px; margin: 0px; font-family: 'Segoe UI'; font-size: 14px;">
    <div id="vertical" style="border-width: 0px; overflow: hidden;">
        <div id="top_pane" style="border-width: 0px; background-color: #eff2f6; overflow: hidden; line-height: 20px;">
            <div style="padding: 1px; padding-top: 3px; vertical-align: top;">
                <button id="upd_refresh"></button>
                <input id="search_word" style="font-size: 13px; width: 235px; " />
                <input id="go_search" type="button" value=">" />
                <input id="fix_rates" type="button" value="Начислить" />
                <button id="excel_report" type="button" style="width: 38px; float: right;"></button>
            </div>
        </div>
        <div id="bottom_pane" style="border-width: 0px; background-color: #eff2f6;">
            <div id="horiz_split" style="height: 100%;">
                <div id="PhoneCalls" style="overflow: hidden; background-color: white; height: 100%;">
                    <div id="treecontainer" style="height: 100%; overflow: auto">
                        <div id="treeview" style="height: 100%"></div>
                    </div>
                </div>
                <div id="Leads" class="k-content" style="height: 100%;">
                    <div id="reportGrid" style="height: 99%;"></div>
                    <div id="clientsView"></div>
                    <div id="saleCard" class="cust-view k-widget" style="display: none; height: 100%;">
                        <dl>
                            <hd id="save_block" style="width: 11%;">
                                <input id="save_client" type="button" value="Сохранить" style="font-size: 13px; display: none;" />
                            </hd>

                            <hd id="urb_caption" style="width: 42%;" ondblclick="snglUpdateFld(this)"></hd>
                            <dd id="urb_caption_block" style="width: 42%; display: none;">
                                <input id="urb_caption_ent" class="k-textbox" placeholder="название объекта, очередь..." style="width: 98%; font-size: 13px;" />
                            </dd>

                            <hd id="urb_number" style="width: 32%;" ondblclick="snglUpdateFld(this)"></hd>
                            <dd id="urb_number_block" style="width: 32%; display: none;">
                                <input id="urb_number_ent" class="k-textbox" placeholder="номер договора..." style="width: 98%; font-size: 13px;" />
                            </dd>

                            <hd id="urb_month" style="width: 8%; font-size: 12px; text-align: right;"></hd>
                            <hd id="urb_year" style="width: 4%; font-size: 12px; text-align: left;"></hd>

                            <!-- два контейнера по 3 строки в каждом -->

                            <dd id="first_container" style="width: 60%; height: 104px;">
                                <dl>

                                    <dt style="width: 80px;">дата начала</dt>

                                    <dd id="urb_start" style="width: 28%; font-size: 15px;" ondblclick="snglUpdateFld(this)"></dd>
                                    <dd id="urb_start_block" style="width: 28%; display: none;">
                                        <input id="urb_start_ent" style="font-size: 13px;" />
                                    </dd>

                                    <dt style="width: 106px;">дата окончания</dt>

                                    <dd id="urb_finish" style="width: 31%; font-size: 15px;" ondblclick="snglUpdateFld(this)"></dd>
                                    <dd id="urb_finish_block" style="width: 31%; display: none;">
                                        <input id="urb_finish_ent" style="font-size: 13px;" />
                                    </dd>

                                    <dt style="width: 80px;">принципал</dt>

                                    <dd id="urb_customer" style="width: 81%;"></dd>
                                    <dd id="urb_customer_block" style="width: 81%; display: none;">
                                        <input id="urb_customer_ent" style="width: 136px; font-size: 13px;" />
                                    </dd>

                                    <dt style="width: 95px;">итог за квартал</dt>

                                    <dd style="width: 5%;">
                                        <input id="urb_isquart" type="checkbox" class="k-check" style="font-size: 13px;" />
                                    </dd>

                                </dl>
                            </dd>
                            <dd id="second_container" style="width: 40%; height: 104px;">
                                <dl>
                                    <dd id="actsContainer" style="height: 101px; width: 100%; border: 1px solid silver; overflow-y: auto;" class="cust-view k-widget">
                                        <div id="actsView" style="margin: 1px;"></div>
                                    </dd>
                                </dl>
                            </dd>

                            <dt style="width: 95%; padding: 1px; font-size: 14px; margin-bottom: 1px; height: 30px; background-color: rgb(209, 211, 222); border-top: 1px solid gray;">
                                <div style="width: 17%; display: inline-block; ">сортировать по:</div>
                                <div style="width: 42%; margin: 2px; display: inline-block; text-align: left;">
                                    <input id="rprt_kinds" style="width: 138px; font-size: 13px; display: inline-block;" />
                                    <input id="sort_kinds" style="width: 128px; font-size: 13px; display: inline-block;" />
                                </div>
                                <div style="width: 38%; margin: 2px; display: inline-block; ">
                                    <!--<input id="add_apps" type="button" value="Добавить строку" />-->
                                    <input id="prnt_act" type="button" value="DOCX - Документ" />
                                </div>
                            </dt>
                            <dt id="lookupCount" style="width: 4%; padding: 1px; margin-bottom: 1px; line-height: 30px; text-align: center; height: 30px; background-color: rgb(209, 211, 222); border-top: 1px solid gray;">
                            </dt>
                            <dd id="appsView_block" style="height: 244px; width: 100%; border: 1px solid silver; overflow-y: auto;" class="cust-view k-widget">
                                <div id="appsView" style="margin: 1px;" placeholder="просмотр строк акта"></div>
                            </dd>
                            <dd id="paysView_block" style="height: 224px; width: 70%; border: 1px solid silver; overflow-y: auto;" class="cust-view k-widget">
                                <div id="paysView" style="margin: 1px;" placeholder="просмотр платежей"></div>
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/x-kendo-tmpl" id="paysListTmpl">
        <div class="cust-view k-widget" style="height: 32px;">
            <dl>
                <dd style="width: 12%;">#:(urb_date && typeof urb_date != 'undefined') ? urb_date.toDateString() : ''#</dd>
                <dt style="width: 18%;">#:(urb_number && typeof urb_number != 'undefined') ? urb_number : ''#</dt>
                <dd style="width: 14%; font-size: 14px;">#:(urb_kind && typeof urb_kind != 'undefined') ? urb_kind : ''#</dd>
                <dd style="width: 21%;">#:(urb_client && typeof urb_client != 'undefined') ? urb_client : ''#</dd>
                <dd style="width: 19%; font-size: 15px; text-align: right;">#:(typeof urb_sum != 'undefined' && urb_sum > 0) ? FormatMoneyValue(urb_sum) : '0'#</dd>
                <dd style="width: 4%;"><input type="checkbox" id="#:uid#" class="k-checkbox" name="isSelected" selected="true"></dd>
            </dl>
        </div>
    </script>

    <script type="text/x-kendo-tmpl" id="appsListTmpl">
        <div class="cust-view k-widget" style="height: 34px;">
            <dl>
                <dd style="background-color: rgb(163, 168, 194); border-style: solid; border-width: 1px; border-color: rgb(216, 219, 232); border-radius: 8px; float: left; height: 40px; width: 34px; margin-right: 4px; padding-right: 4px;">
                    <p style="font-size: 15px; width: 110%; margin: 0; line-height: 15px; font-weight: 400; text-align: center; color: white;">#:(urb_date && typeof urb_date != 'undefined') ? urb_date.getDate().toString() : ''#</p>
                    <p style="font-size: 16px; width: 110%; margin: 0; line-height: 11px; font-weight: 400; text-align: center; color: white;">#:(urb_date && typeof urb_date != 'undefined') ? urb_date.toLocaleString().substr(urb_date.getDate().toString().length + 1, 3) : ''#</p>
                </dd>
                <dd style="width: 21%;">#:(urb_number && typeof urb_number != 'undefined') ? urb_number : ''#</dd>
                <dd style="width: 13%; font-size: 14px;">#:(urb_kind && typeof urb_kind != 'undefined') ? urb_kind : ''#</dd>
                <dt style="width: 5%;">фио</dt> <!--39-->
                <dd style="width: 21%;">#:(urb_client && typeof urb_client != 'undefined') ? urb_client : ''#</dd>
                <dt style="width: 9%;">сумма</dt>  <!--69-->
                <dd style="width: 16%; font-size: 15px; text-align: right;">#:(typeof urb_sum != 'undefined' && urb_sum > 0) ? FormatMoneyValue(urb_sum) : '0'#</dd>
            </dl>
        </div>
    </script>

    <script type="text/x-kendo-tmpl" id="appsListEditTmpl">
        <div class="cust-view k-widget" style="height: 34px;">
            <dl>
                <dd style="width: 12%;">
                    <input type="text" class="k-textbox" data-bind="value:urb_kind" name="urb_kind" />
                </dd>
                <dd style="width: 9%; font-size: 13px;">#:urb_date.toLocaleDateString()#</dd>
                <dt style="width: 5%;">фио</dt>
                <dd style="width: 15%;">
                    <input type="text" class="k-textbox" data-bind="value:urb_client" name="urb_client" />
                </dd> <!--37-->
                <dt>№ контракта</dt>
                <dd style="width: 17%;">
                    <input type="text" class="k-textbox" data-bind="value:urb_number" name="urb_number" />
                </dd> <!--69-->
                <dt style="width: 9%;">сумма</dt>
                <dd style="width: 13%; font-size: 15px;">#:(typeof urb_sum != 'undefined' && urb_sum > 0) ? FormatMoneyValue(urb_sum) : '0'#</dd>
                <dd style="width: 5%;">
                    <a class="k-button k-update-button" href="\\#"><span class="k-icon k-update"></span></a>
                </dd>
            </dl>
        </div>
    </script>
    
    <script type="text/x-kendo-tmpl" id="planListTmpl">
        <div class="cust-view k-widget" ondblclick="planItemDblClick();" style="height: 36px; #:(typeof manName != 'undefined' || typeof isTotal != 'undefined') ? '' : 'border-top: 1px solid rgb(163, 168, 194)'#">
            <dl style="margin-bottom: 4px; padding-bottom: 4px; border-bottom: 2px solid rgb(206, 215, 226)">
                <dt style="width: #:(typeof manName != 'undefined') ? '2' : (typeof isTotal != 'undefined') ? '24' : '6'#%;">#:(typeof manName != 'undefined') ? '' : (typeof isTotal != 'undefined') ? 'ИТОГ ПО МЕНЕДЖЕРАМ:' : 'ПРОЕКТ'#</dt>
                <hd style="width: #:(typeof manName != 'undefined') ? '2' : (typeof isTotal != 'undefined') ? '9' : '27'#%; font-weight: bold;">#:(typeof manName != 'undefined' || typeof isTotal != 'undefined') ? '' : objName#</hd>
                <hd style="width: #:(typeof manName != 'undefined') ? '16' : '1'#%;">#:(typeof manName != 'undefined') ? manName : ''#</hd>
                <hd style="width: #:(typeof manName != 'undefined') ? '20' : '1'#%;">#:(typeof manRole != 'undefined') ? manRole : ''#</hd>
                <dt id="#:'dtSquare' + uid#" style="width: #:(typeof manName != 'undefined') ? '1' : '6'#%;">#:(typeof manName != 'undefined') ? '' : (typeof isTotal != 'undefined') ? 'м² (ОТ ' + ((typeof objSquare != 'undefined' && objSquare) ? kendo.toString(objSquare, 'n0') : '') + ')' : 'план: м²'#</dt>
                <hd id="#:'stSquare' + uid#" style="width: 6%; text-align: right; font-weight: #:(typeof manName != 'undefined' || typeof isTotal != 'undefined') ? 'normal' : 'bold'# ">#:(typeof planSquare != 'undefined' && planSquare != null && planSquare > 0) ? kendo.toString(planSquare, '0') : ''#</hd>
                <dd id="#:'inSquare' + uid#" style="width: 6%; display: none; ">
                    <input id="#:'squarepick' + uid#" style="width: 77px; font-size: 13px;" />
                </dd>
                <dt id="#:'dtValue' + uid#" style="width: 11%;">#:(typeof manName != 'undefined') ? '' : (typeof isTotal != 'undefined') ? 'руб (ОТ ' + ((typeof objValue != 'undefined' && objValue) ? kendo.toString(objValue, 'n0') : '') + ')' : 'выручка'#</dt>
                <hd id="#:'stValue' + uid#" style="width: 12%; text-align: right; font-weight: #:(typeof manName != 'undefined' || typeof isTotal != 'undefined') ? 'normal' : 'bold'# ">#:(typeof planValue != 'undefined' && planValue != null && planValue > 0) ? kendo.toString(planValue, 'c') : ''#</hd>
                <dd id="#:'inValue' + uid#" style="width: 12%; display: none; ">
                    <input id="#:'valuepick' + uid#" style="width: 120px; font-size: 13px;" />
                </dd>
                <dt id="#:'dtObjrate' + uid#" style="width: 11%;">#:(typeof manName != 'undefined' || typeof isTotal != 'undefined') ? '' : 'за долю'#</dt>
                <hd id="#:'stObjrate' + uid#" style="width: 6%; text-align: right; font-weight: #:(typeof manName != 'undefined' || typeof isTotal != 'undefined') ? 'normal' : 'bold'# ">#:(typeof objRate != 'undefined' && objRate != null && objRate > 0) ? kendo.toString(objRate, '0.00') : ''#</hd>
                <dd id="#:'inObjrate' + uid#" style="width: 6%; display: none; ">
                    <input id="#:'objratepick' + uid#" style="width: 66px; font-size: 13px;" />
                </dd>
            </dl>
        </div>
    </script>

    <script type="text/x-kendo-tmpl" id="clientListTmpl">
        <div class="cust-view k-widget" ondblclick="actListDblClick();">
            <dl style="margin-bottom: 4px; padding-bottom: 4px; border-bottom: 2px solid rgb(206, 215, 226)">
                <dd style="background-color: rgb(163, 168, 194); border: solid 2px rgb(216, 219, 232); border-radius: 10px; float: left; height: 46px; width: 46px; margin: 4px; padding-right: 4px;">
                    <p style="font-size: 18px; width: 110%; margin: 0; line-height: 16px; font-weight: 400; text-align: center; color: white;">#:urb_signdate.getDate().toString()#</p>
                    <p style="font-size: 16px; width: 110%; margin: 0; line-height: 10px; font-weight: 400; text-align: center; color: white;">#:urb_signdate.toLocaleString().substr(urb_signdate.getDate().toString().length + 1, 3)#</p>
                    <p style="font-size: 18px; width: 110%; margin: 0; line-height: 20px; font-weight: 400; text-align: center; color: white;">#:urb_signdate.getFullYear().toString()#</p>
                </dd>
                <hd style="width: 35%;">#:urb_number#</hd>
                <dt>#:(typeof urb_pay_sum != 'undefined' && urb_pay_sum > 0) ? 'сумма оплат' : ''#</dt>
                <hd style="width: 14%; color: #=alert_color#;">#=(typeof urb_pay_sum != 'undefined' && urb_pay_sum > 0) ? kendo.toString(urb_pay_sum, 'c') : ''#</hd>
                <dt id="#:'actdatehdr' + uid#"></dt>
                <hd id="#:'stactdate' + uid#" style="width: 16%;">#:(urb_act1_date != null && typeof urb_act1_date != 'undefined' && urb_act1_date != '') ? urb_act1_date.toLocaleDateString() : ''#</hd>
                <dd id="#:'inactdate' + uid#" style="width: 16%; display: none; ">
                    <input id="#:'datepick' + uid#" style="width: 120px; font-size: 13px;" />
                </dd>
                <dt style="width: 6%;">Клиент</dt>
                <dd style="width: 22%; font-size: 15px;">#:(urb_customer.Name) ? urb_customer.Name : ''#</dd>
                <dt style="width: 10%;">Тип договора</dt>
                <dd style="width: 44%; font-size: 15px;">#:urb_cntrct_type#</dd>
            </dl>
        </div>
    </script>

    <!--<script type="text/x-kendo-tmpl" id="historyTmpl">
        <div class="cust-view k-widget" style="height: 32px; background-color: rgb(209, 211, 222);" ondblclick="listItemDblClick();">
            <dl>
                <dd style="width: 39%; font-size: 15px;">#:urb_month + ' ' + urb_year#</dd>
                <dt style="width: 16%;">#:(typeof urb_sum != 'undefined' && urb_sum > 0) ? 'сумма' : ''#</dt>
                <dd style="width: 42%; font-size: 16px;">#:(typeof urb_sum != 'undefined' && urb_sum > 0) ? kendo.toString(urb_sum, 'c') : ''#</dd>
            </dl>
        </div>
    </script>-->

    <script type="text/javascript">

        var fltrManUid = _isUserMaster();

        var contractModel = {
            Entity: 'SalesOrder', PRT_Nodename: 'Name', urb_Id: 'SalesOrderId', urb_number: 'Name', urb_agree_no: 'mtr_namewithoutspace',
            urb_act1_date: 'mtr_act_date1', urb_act1_value: 'mtr_act_amount1', urb_appart: 'mtr_apartmentid', urb_customer: 'CustomerId', 
            urb_garage: 'mtr_parkingid', urb_stock: 'mtr_pantryid', urb_signdate: 'mtr_date_signed',
            urb_amount: 'snrlt_totalamount', urb_cntrct_type: 'snrlt_contracttype', urb_status: 'StatusCode',
            urb_bonus_date: 'mtr_bonus_date', urb_bonus_rate: 'mtr_bonus_rate', urb_bonus_perc: 'mtr_bonus_percent',
            urb_bonus_rate_co: 'mtr_bonus_rate_co', urb_bonus_perc_co: 'mtr_bonus_percent_co',
            urb_cntrct_date: 'CreatedOn', urb_updt_date: 'ModifiedOn'
        };

        var opprtntModel = {
            Entity: 'Opportunity', urb_oppId: 'OpportunityId', urb_bld_object: 'snrlt_buildinggroupid', urb_obj_owner: 'snrlt_organizationid',
            urb_main_manager: 'OwnerId', urb_add_manager: 'mtr_manager2id', urb_sale_amount: 'snrlt_dpsum',
            urb_sale_disc_amount: 'mtr_dpsumdiscount', urb_pay_kind: 'mtr_payment'
        };

        var appartModel = {
            Entity: 'snrlt_apartment', urb_appId: 'snrlt_ApartmentId', urb_app_type: 'snrlt_premisestype', urb_area: 'snrlt_spacedesign'
        }

        var planningModel = {
            Entity: 'mtr_targets', urb_Id: 'mtr_targetsId', urb_objProject: 'mtr_buildinggroupid', urb_year: 'mtr_yearplan',
            urb_month: 'mtr_monthplan', urb_quart: 'mtr_quarterplan', urb_period: 'mtr_period', urb_plan_amount: 'mtr_plan_value',
            urb_plan_square: 'mtr_meterplan', urb_manager: 'mtr_salesperson', urb_man_role: 'mtr_salesperson_role', urb_rsn_ratio: 'mtr_raising_ratio', urb_rsn_factor: 'mtr_raising_factor'
        }

        var connectModel = {
            Entity: 'Connection', urb_Id: 'ConnectionId', urb_link_from: 'Record1Id', urb_role_from: 'Record1RoleId', urb_link_to: 'Record2Id', urb_role_to: 'Record2RoleId'
        }

        var ratingModel = {
            Entity: 'mtr_plan_rating', urb_Id: 'mtr_plan_ratingId', urb_perc_from: 'mtr_percent_from', urb_perc_to: 'mtr_percent_to',
            urb_rate_mnth: 'mtr_month_rate', urb_rate_quart: 'mtr_quarter_rate', urb_role: 'mtr_role'
        }

        var actModel = {
            Entity: 'mtr_act', urb_Id: 'mtr_actId', urb_name: 'mtr_name', urb_year: 'mtr_period_year',
            urb_month: 'mtr_period_month', urb_contract: 'mtr_suppliercontract', urb_isquart: 'mtr_quart_totals'
        };

        var paysModel = {
            Entity: 'snrlt_payment', urb_payId: 'snrlt_paymentId', urb_pay_sum: 'snrlt_sumpay', urb_pay_date: 'snrlt_datepay'
        };

        var transModel = {
            Entity: 'Entity', urb_Id: 'urb_Id', urb_sum: 'urb_sum', urb_number: 'urb_agree_num', urb_agree_sum: 'urb_agree_sum',
            urb_kind: 'urb_app_type', urb_date: 'urb_agree_date', urb_client: 'urb_agree_clnt', urb_square: 'urb_app_square'
        };

        var allRefs = { // -> TODO: загружать из метаданных
            editCntrlPstfx: '_ent',
            terms: { commaSep: ',', andFlrSep: ' and ', orFltrSep: ' or '},
            docxTmpl: 'curract.docx',
            defaults: { appTypes: 251170000, cntrctTypes: 251170000, periods: 962090002, monthes: 1, payTypes: 962090000 },
            defaultClient: {},
            srtOrdrs: { 0: 'По возрастанию', 1: 'По убыванию' },
            repPrds: { urb_agree_date: 'Дата договора', urb_agree_num: 'Номер договора', urb_app_type: 'Тип помещения', urb_agree_clnt: 'Имя клиента(ов)', urb_agree_sum: 'Сумма' },
            recCount: 'urb_records_cnt',
            joinPref: 'mtr_act_mtr_act_record',
            joinPays: 'snrlt_salesorder_payment_salesorderid',
            joinOppr: 'opportunity_sales_orders',
            joinApps: 'mtr_apartmentforsalesorder',
            joinConn: 'snrlt_buildinggroup_connections1', // or snrlt_buildinggroup_connections2
            required: { urb_number: true, urb_start: true, urb_customer: true },
            partyLoad: { PRT_Nodename: 0 },
            partySave: { FullName: 'FirstName;LastName' },
            boolAttr: { urb_isquart: true },
            optsAttr: { urb_app_type: 'appTypes', urb_month: 'monthes', urb_year: 'years', urb_cntrct_type: 'cntrctTypes', urb_pay_kind: 'payTypes' },
            lookAttr: { urb_customer: 'Account', urb_parentact: 'mtr_act', urb_contract: 'mtr_suppliercontract' },
            numsAttr: {},
            moneyAttr: { urb_amount: 0 },
            dateAttr: { urb_start: 0, urb_finish: 0, sqr_start: 0, mtr_date_signed: 0, urb_act1_date: 0, urb_signdate: 0, urb_cntrct_date: 0, urb_pay_date: 0, urb_bonus_date: 0 },
            mailAttr: { urb_email: 'Metrium' },
            totalAttr: { urb_sum: 'urb_kind', urb_square: 'urb_kind' },
            totalsPst: { urb_sum: 'sum', urb_square: 'sqr' },
            nodeValues: { 0: 'План продаж', 1: 'Начисления', 2: 'Актирование', 3: 'К оплате' },
            quartNode: 'Итоги',
            totalGroups: { urb_flat: 'Квартиры', urb_appart: 'Апартаменты', urb_garage: 'Машиноместа' },
            years: { 2015: 2015 }, // -> первый год ведения наблюдений в сущности mtr_act, остальные годы до текущего добавляются автоматически forceYears
            periods: { 962090000: 'Год', 962090001: 'Квартал', 962090002: 'Месяц' },
            monthes: {
                1: 'Январь', 2: 'Февраль', 3: 'Март', 4: 'Апрель', 5: 'Май', 6: 'Июнь',
                7: 'Июль', 8: 'Август', 9: 'Сентябрь', 10: 'Октябрь', 11: 'Ноябрь', 12: 'Декабрь'
            },
            cntrctTypes: {
                251170000: 'Бронирование', 251170001: 'Бронирование и Оформление', 251170002: 'Оформление', 251170003: 'ДДУ',
                962090000: 'УДДУ', 251170004: 'ДКП', 251170006: 'ПДКП', 962090001: 'Договор соинвестирования', 251170005: 'ДОУ'
            },
            appTypes: {
                251170000: 'Квартира', 251170001: 'Апартаменты', 251170004: 'Нежилое'
            },
            payTypes: {
                962090000: '100%', 962090001: 'Рассрочка', 962090002: 'Ипотека'
            },
            getTotals: function (countedRecs) {
                var retTotals = {};

                for (var step = 0, sLngth = countedRecs.length; step < sLngth; step++) {
                    var countUnits = true;

                    for (var prop in allRefs.totalAttr) {
                        for (var inProp in allRefs.totalGroups) {
                            if (prop in countedRecs[step] && countedRecs[step][allRefs.totalAttr[prop]] == allRefs.totalGroups[inProp]) {
                                var stPropNm = inProp + '_' + ((prop in allRefs.totalsPst) ? allRefs.totalsPst[prop] : 'total');
                                var cntPropNm = inProp + '_units';

                                var sdtTotal = (stPropNm in retTotals) ? GetParseNum(retTotals[stPropNm]) : 0;
                                var cntTotal = (cntPropNm in retTotals) ? GetParseNum(retTotals[cntPropNm]) : 0;
                                var allTotal = (allRefs.recCount in retTotals) ? GetParseNum(retTotals[allRefs.recCount]) : 0;

                                retTotals[stPropNm] = GetParseNum(countedRecs[step][prop]) + sdtTotal;
                                if (countUnits) {
                                    retTotals[cntPropNm] = 1 + cntTotal;
                                    retTotals[allRefs.recCount] = 1 + allTotal;
                                }
                            }
                        }
                        countUnits = false;
                    }
                }

                return retTotals;
            },
            mnthPayments: function (yearVal, mnthVal, cntrUid) {
                var beginDate = new Date(yearVal, mnthVal - 1, 1, 0, 0, 1),
                    overDate = new Date(yearVal, mnthVal, 0, 23, 59, 59);

                return allRefs.payments(beginDate, overDate, cntrUid);
            },
            payments: function (beginDate, overDate, cntrUid) {
                var _hardFilter = [];
                _hardFilter[0] = _snglFltr_NumberCompare(paysModel.urb_percent, '1', ((cntrUid.toUpperCase() == '1CCF4A52-B1BD-E511-892C-00155D0A3302' ||
                    cntrUid.toUpperCase() == 'B65343FA-CFBD-E511-892C-00155D0A3302') ? 'gt' : 'eq'));
                _hardFilter[1] = _snglFltr_BeginsWith(paysModel.urb_app_bld,
                    (cntrUid.toUpperCase() == '55993E16-D0B6-E511-892C-00155D0A3302') ? encodeURIComponent('Фили Град, ') :
                    (cntrUid.toUpperCase() == 'D9B4307A-DDB6-E511-892C-00155D0A3302') ? encodeURIComponent('Фили Град 2, ') :
                    (cntrUid.toUpperCase() == '16A5EAFC-95BB-E511-892C-00155D0A3302') ? encodeURIComponent('Водный, ') :
                    (cntrUid.toUpperCase() == '1CCF4A52-B1BD-E511-892C-00155D0A3302') ? encodeURIComponent('ЭКО Видное, ') :
                    (cntrUid.toUpperCase() == 'B65343FA-CFBD-E511-892C-00155D0A3302') ? encodeURIComponent('Двинцев ') : 'XXX');

                _hardFilter[2] = _snglFltr_DateComp('mtr_pay_date', beginDate, 'ge', true);
                _hardFilter[3] = _snglFltr_DateComp('mtr_pay_date', overDate, 'le');

                _hardFilter[4] = _snglFltr_StringEquals('mtr_pay_num', encodeURIComponent('бти'), true);

                _hardFilter[5] = _snglFltr_NumberCompare('mtr_pay_type', 5, 'ne');
                _hardFilter[6] = _snglFltr_NumberCompare('mtr_pay_type', 8, 'ne');
                //_hardFilter[5] = _snglFltr_StringEquals('mtr_pay_num', encodeURIComponent('возврат'), true);

                var paysSet = _syncAjax(_getServerUrl(), paysModel['Entity'], _objectUrbSelect(paysModel), _hardFilter.join(' and '));

                return (paysSet.d && paysSet.d.results) ? allRefs._parsePays(paysSet.d.results) : [];
            },
            _parsePays: function (paysRecs) {
                var retPays = [];
                var paysRefr = {};

                for (var step = 0, sLngth = paysRecs.length; step < sLngth; step++) {
                    var stepPay = GetModelObject(paysModel, paysRecs[step]);

                    if (stepPay['urb_agree_num'] in paysRefr) {
                        var updIndx = paysRefr[stepPay['urb_agree_num']];
                        retPays[updIndx]['urb_sum'] = GetParseNum(retPays[updIndx]['urb_sum']) + GetParseNum(stepPay['urb_sum']);
                    }
                    else {
                        paysRefr[stepPay['urb_agree_num']] = GetParseNum(retPays.length.toString());
                        retPays[retPays.length] = stepPay;
                    }
                }

                return retPays;
            },
            PeriodObject: function (year, month, monthName) {
                /// <summary> Объект - период. Нумерация месяцев должна начинаться с "1"
                /// TODO: добавить квартал и получение дат начала и окончания периода </summary>
                month = _setOrDefault(month, 1);
                
                return {
                    monthValue: month,
                    periodName: _get2DigStr(month) + year.toString(),
                    monthName: _setOrDefault(monthName, allRefs.monthes[month]),
                    yearValue: year,
                    startDate: new Date(year, month - 1, 0, 20, 59, 59),
                    finishDate: new Date(year, month, 0, 21, 0, 0)
                }
            },
            ServicNode: function (nodeName, nodeYear, nodeMonth) {
                return {
                    year: nodeYear,
                    month: nodeMonth,
                    Nodename: nodeName,
                    hasChildren: false
                };
            },
            getMonthServNodes: function (currYear, currMonth) {
                var childNodes = [];
                for (var loop = 0; loop < 4; loop++)
                    childNodes[loop] = allRefs.ServicNode(allRefs.nodeValues[loop], currYear, currMonth);

                return childNodes;
            },
            MonthNode: function (currYear, monthValue, monthName) {
                return {
                    monthOptions: allRefs.getMonthServNodes(currYear, monthValue),
                    hasChildren: true,
                    children: 'monthOptions',
                    text: monthName
                };
            },
            getQuartServNodes: function (currYear, quartValue) {
                var childNodes = [];

                childNodes[0] = {
                    year: currYear,
                    month: 0,
                    quarter: quartValue,
                    Nodename: allRefs.quartNode,
                    hasChildren: false
                };

                return childNodes;
            },
            QuartNode: function (currYear, quartValue, quartName) {
                return {
                    quartOptions: allRefs.getQuartServNodes(currYear, quartValue),
                    hasChildren: true,
                    children: 'quartOptions',
                    text: quartName
                };
            },
            PlanRecord: function (planData, objData, connData) {
                /// <summary> Объект - запись плана продаж. Бывает трёх видов: объект, менеджер и итог по менеджерам.
                /// для менеджера: connData != null; итог по менеджерам - planData не является массивом</summary>
                var planRec = {};
                planRec.objUid = objData.Id;
                planRec.objName = objData.Name;
                planRec.manUid = (connData) ? connData[connectModel.urb_link_to].Id : '';
                
                if (connData) {
                    planRec.manName = getViewName(connData[connectModel.urb_link_to].Name);
                    planRec.manRole = connData[connectModel.urb_role_to].Name;
                }
                
                if ('objValue' in planData && 'objSquare' in planData) {  // Итог по менеджерам - атрибут isTotal определяется только в этом случае
                    planRec.isTotal = true; // 

                    for (var prop in planData) planRec[prop] = planData[prop];
                }
                else if (_isArrayFill(planData)) {
                    for (var loop = 0, lLngth = planData.length; loop < lLngth; loop++)
                        if (_setOrDefault(planData[loop][planningModel.urb_manager].Id) == planRec.manUid &&
                            _setOrDefault(planData[loop][planningModel.urb_objProject].Id) != '' &&
                            _setOrDefault(planData[loop][planningModel.urb_objProject].Id) == objData.Id) {

                            if (connData && _setOrDefault(planData[loop][planningModel.urb_man_role]) != '')
                                planRec.manRole = planData[loop][planningModel.urb_man_role];
                            else
                                planRec.objRate = _setOrDefault(GetParseNum(planData[loop][planningModel.urb_rsn_factor]), 0);

                            planRec.planUid = planData[loop][planningModel.urb_Id];
                            planRec.planValue = _setOrDefault(GetParseNum(planData[loop][planningModel.urb_plan_amount]), 0);
                            planRec.planSquare = _setOrDefault(planData[loop][planningModel.urb_plan_square], 0);
                            break;
                        }
                }

                if (typeof planRec.planSquare == 'undefined') planRec.planSquare = 0;
                if (typeof planRec.planValue == 'undefined') planRec.planValue = 0;

                return planRec;
            },
            addPlanRec: function (year, month, savedPlan, recData) {
                if (_setOrDefault(recData['manUid']) != '')
                    savedPlan[planningModel.urb_manager] = _getLookup(recData['manUid'], 'systemuser');

                savedPlan[planningModel.urb_year] = GetParseNum(year);
                savedPlan[planningModel.urb_month] = { Value: GetParseNum(month) };
                savedPlan[planningModel.urb_period] = { Value: allRefs.defaults.periods };
                savedPlan[planningModel.urb_man_role] = _setOrDefault(recData['manRole']);
                savedPlan[planningModel.urb_objProject] = _getLookup(recData['objUid'], 'snrlt_buildinggroup');
                savedPlan['mtr_name'] = recData['objName'] + ' ' + allRefs.monthes[month].substr(0, 3).toUpperCase() + ' ' + year;

                var newPlan = _createAjax(_getServerUrl(), planningModel['Entity'], savedPlan);

                if (newPlan.d && planningModel.urb_Id in newPlan.d)
                    savedPlan[planningModel.urb_Id] = newPlan.d[planningModel.urb_Id];
            },
            prjectsFltr: function () {
                /// <summary> Фильтр для получения всех объектов, соединенных с менеджерами
                /// В отбор попадают записи, привязанные как "Старший менеджер" или "Специалист по продажам" </summary>
                var retFltr = [];
                retFltr[0] = _snglFltr_GuidEquals(connectModel.urb_role_to + '/Id', 'C04EDE2A-B7D3-E511-BF03-00155D0A3302'); // Старший менеджер
                retFltr[1] = _snglFltr_GuidEquals(connectModel.urb_role_to + '/Id', '3B7F4860-0828-4CC2-8BBE-D91C72B76B64'); // Специалист по продажам

                return retFltr.join(allRefs.terms.orFltrSep);
            },
            prjects: function () {
                var rtrvData = _syncAjax(_getServerUrl(), connectModel.Entity, _objectUrbSelect(connectModel), allRefs.prjectsFltr());

                return (rtrvData.d && _isArrayFill(rtrvData.d.results)) ? rtrvData.d.results : [];
            },
            _plansData: {},
            plansFltr: function (fltrYear, fltrPeriodKind, fltrPeriodId) {
                /// <summary> Фильтр для получения планов, по проектам и менеджерам
                /// В отбор попадают записи по году и периоду, которым может быть как месяц, так и квартал </summary>
                var retFltr = [];
                retFltr[0] = _snglFltr_NumberCompare(planningModel.urb_year, fltrYear); // год
                retFltr[1] = _snglFltr_OptionComp(planningModel.urb_period, _setOrDefault(fltrPeriodKind, allRefs.defaults.periods)); // тип периода - по идее должен быть передан особо, но речь о том, что квартальный план = сумма помесячных
                if (fltrPeriodKind == allRefs.defaults.periods)
                    retFltr[2] = _snglFltr_OptionComp(planningModel.urb_month, _setOrDefault(fltrPeriodId, allRefs.defaults.monthes)); // собственно период
                
                return retFltr.join(allRefs.terms.andFlrSep);
            },
            plannings: function (selYear, selPeriodKind, selPeriod) {
                var periodCpt = _get2DigStr(selPeriod) + selYear.toString();

                if (!_isArrayFill(allRefs._plansData[periodCpt])) {
                    var rtrvData = _syncAjax(_getServerUrl(), planningModel.Entity, _objectUrbSelect(planningModel),
                            allRefs.plansFltr(selYear, selPeriodKind, selPeriod));

                    allRefs._plansData[periodCpt] = (rtrvData.d && _isArrayFill(rtrvData.d.results)) ? rtrvData.d.results : [];
                }
                
                return allRefs._plansData[periodCpt];
            },
            planningsRef: function (selYear, selPeriodKind, selPeriod, refRecord) {
                var periodCpt = _get2DigStr(selPeriod) + selYear.toString();

                if (!_isArrayFill(allRefs._plansData[periodCpt])) return;

                var findFlag = false;

                for (var step = 0, sLngth = allRefs._plansData[periodCpt].length; step < sLngth; step++)
                    if (allRefs._plansData[periodCpt][step][planningModel.urb_Id] == refRecord[planningModel.urb_Id]) {
                        findFlag = true;

                        for (var prop in refRecord) {
                            allRefs._plansData[periodCpt][step][prop] = refRecord[prop];
                        }
                        break;
                    }

                if (!findFlag) allRefs._plansData[periodCpt].push(refRecord);
            },
            _contrData: {},
            _actcontrdata: [],
            _cancontrdata: [],
            contractsGoAct: false,
            contractsGoCanc: false,
            contractsFltrDflt: function () {
                /// <summary> Базовый фильтр для получения данных договоров
                /// Отбор: связанные со сделками, с номером и датой фактического подписания</summary>
                var retFltr = [];
                retFltr[0] = _snglFltr_NotNull('OpportunityId');
                retFltr[1] = _snglFltr_NotNull(contractModel.urb_number);
                retFltr[2] = _snglFltr_NotNull(contractModel.urb_signdate);
                retFltr[3] = _snglFltr_OptionComp(contractModel.urb_cntrct_type, 251170002, 'le');

                return retFltr;
            },
            contractsFltr: function (periodicFld, endSetDate, startSetDate) {
                /// <summary> Фильтр для получения данных договоров.
                /// Использует базовый отбор, плюс: подписанные в заданном интервале дат</summary>
                var exstFltr = []; // фильтр: действующие контракты, подписанные в заданном интервале
                exstFltr[0] = _snglFltr_OptionComp(contractModel.urb_status, 4, 'ne');
                exstFltr[1] = _snglFltr_DateComp(periodicFld, endSetDate, 'lt');
                exstFltr[2] = _snglFltr_DateComp(contractModel.urb_signdate, startSetDate, 'gt');

                var cancFltr = []; // фильтр: расторгнутые в заданном интервале - контракты, ранее попавшие в план, в текущем периоде нужно вычесть из плана. Те, которые были заключены и тут же расторгнуты - вообще никуда не должны попасть
                cancFltr[0] = _snglFltr_OptionComp(contractModel.urb_status, 4, 'eq');
                //cancFltr[1] = _snglFltr_NotNull(contractModel.urb_bonus_rate);
                cancFltr[1] = _snglFltr_NumberCompare(contractModel.urb_bonus_rate, 0, 'gt');

                cancFltr[2] = _snglFltr_DateComp(contractModel.urb_updt_date, startSetDate, 'gt'); // дата изменения (отметка о расторжении) должна входить в текущий интервал
                cancFltr[3] = _snglFltr_DateComp(contractModel.urb_updt_date, endSetDate, 'lt');
                cancFltr[4] = _snglFltr_DateComp(contractModel.urb_signdate, new Date(2016, 0, 1, 0, 0, 1), 'gt'); // интервал подписания с начала отсчета времени мотивации, т. е. 1 января 2016
                cancFltr[5] = _snglFltr_DateComp(contractModel.urb_signdate, startSetDate, 'lt');                  // по дату начала периода
                //cancFltr[5] = _snglFltr_NotNull(contractModel.urb_bonus_rate);
                //cancFltr[6] = _snglFltr_NumberCompare(contractModel.urb_bonus_rate, 0, 'gt');

                var cancmrkFltr = []; // фильтр: расторгнутые договоры, по которым было начисление в данном периоде, нужно учитывать - для случаев просмотра ведомости начислений предыдущих периодов
                cancmrkFltr[0] = _snglFltr_OptionComp(contractModel.urb_status, 4, 'eq');
                cancmrkFltr[1] = _snglFltr_DateComp(periodicFld, endSetDate, 'lt');
                cancmrkFltr[2] = _snglFltr_DateComp(contractModel.urb_signdate, startSetDate, 'gt');
                cancmrkFltr[3] = _snglFltr_DateComp(contractModel.urb_updt_date, endSetDate, 'gt');
                cancmrkFltr[4] = _snglFltr_NotNull(contractModel.urb_bonus_rate);
                //cancmrkFltr[5] = _snglFltr_NumberCompare(contractModel.urb_bonus_rate, 0, 'gt');
                // особо формируются данные за март 2016
                //if (endSetDate.getFullYear() == 2016 && endSetDate.getMonth() == 2 && endSetDate.getDate() == 31)
                //    cancFltr[3] = _snglFltr_DateComp('ModifiedOn', new Date(2016, 0, 1, 0, 0, 1), 'gt');
                //else
                
                var retFltr = allRefs.contractsFltrDflt();
                // особо формируются данные и за январь-февраль 2016, когда расторжения не брались в расчет
                //if (endSetDate.getFullYear() == 2016 && endSetDate.getMonth() < 2)
                //    retFltr[retFltr.length] = exstFltr.join(allRefs.terms.andFlrSep);
                //else
                    retFltr[retFltr.length] = '((' + exstFltr.join(allRefs.terms.andFlrSep) + ')' +
                        allRefs.terms.orFltrSep + '(' + cancFltr.join(allRefs.terms.andFlrSep) + ')' +
                        allRefs.terms.orFltrSep + '(' + cancmrkFltr.join(allRefs.terms.andFlrSep) + '))';
                
                return retFltr.join(allRefs.terms.andFlrSep);
            },
            contractsFltrAlt: function (periodicFld, endSetDate, startSetDate) {
                var retFltr = [];
                retFltr[0] = _snglFltr_NotNull('OpportunityId');
                retFltr[1] = _snglFltr_NotNull(contractModel.urb_number);
                retFltr[2] = _snglFltr_OptionComp(contractModel.urb_cntrct_type, 251170002, 'le');
                /// <summary> Фильтр для получения данных договоров.
                /// Использует базовый отбор, плюс: подписанные в заданном интервале дат</summary>
                var exstFltr = []; // фильтр: действующие контракты, подписанные в заданном интервале
                exstFltr[0] = _snglFltr_OptionComp(contractModel.urb_status, 4, 'ne');
                exstFltr[1] = _snglFltr_DateComp(periodicFld, endSetDate, 'lt');
                exstFltr[2] = _snglFltr_DateComp(contractModel.urb_signdate, startSetDate, 'gt');

                var cancFltr = [];
                cancFltr[0] = _snglFltr_OptionComp(contractModel.urb_status, 4, 'eq');
                cancFltr[1] = _snglFltr_NumberCompare(contractModel.urb_bonus_rate, 0, 'gt');
                cancFltr[2] = _snglFltr_DateComp(contractModel.urb_updt_date, startSetDate, 'gt');
                cancFltr[3] = _snglFltr_DateComp(contractModel.urb_signdate, new Date(2016, 0, 1, 0, 0, 1), 'gt');
                cancFltr[4] = _snglFltr_DateComp(contractModel.urb_signdate, endSetDate, 'lt');

                retFltr.push('((' + exstFltr.join(allRefs.terms.andFlrSep) + ')' + allRefs.terms.orFltrSep + '(' + cancFltr.join(allRefs.terms.andFlrSep) + '))');

                return retFltr.join(allRefs.terms.andFlrSep);
            },
            contractsFltrAct: function (endSetDate, startSetDate) {
                var retFltr = [];
                retFltr[0] = _snglFltr_NotNull('OpportunityId');
                retFltr[1] = _snglFltr_NotNull(contractModel.urb_number);
                retFltr[2] = _snglFltr_OptionComp(contractModel.urb_status, 4, 'ne');
                retFltr[3] = _snglFltr_DateComp(contractModel.urb_signdate, endSetDate, 'lt');
                retFltr[4] = _snglFltr_DateComp(contractModel.urb_signdate, startSetDate, 'gt');
                retFltr[5] = _snglFltr_OptionComp(contractModel.urb_cntrct_type, 251170002, 'le');

                return retFltr.join(allRefs.terms.andFlrSep);
            },
            contractFltrCanc: function (endSetDate, startSetDate) {
                var retFltr = [];
                retFltr[0] = _snglFltr_NotNull('OpportunityId');
                retFltr[1] = _snglFltr_NotNull(contractModel.urb_number);
                retFltr[2] = _snglFltr_OptionComp(contractModel.urb_status, 4, 'eq');
                retFltr[3] = _snglFltr_OptionComp(contractModel.urb_cntrct_type, 251170002, 'le');

                var cancFltr = [];
                cancFltr[0] = _snglFltr_DateComp(contractModel.urb_updt_date, startSetDate, 'gt'); // дата изменения (отметка о расторжении) должна входить в текущий интервал
                cancFltr[1] = _snglFltr_DateComp(contractModel.urb_updt_date, endSetDate, 'lt');
                cancFltr[2] = _snglFltr_DateComp(contractModel.urb_signdate, new Date(2016, 0, 1, 0, 0, 1), 'gt'); // интервал подписания с начала отсчета времени мотивации, т. е. 1 января 2016
                cancFltr[3] = _snglFltr_DateComp(contractModel.urb_signdate, startSetDate, 'lt');

                var usedFltr = [];
                usedFltr[0] = _snglFltr_DateComp(contractModel.urb_signdate, endSetDate, 'lt');
                usedFltr[1] = _snglFltr_DateComp(contractModel.urb_signdate, startSetDate, 'gt');
                usedFltr[2] = _snglFltr_DateComp(contractModel.urb_updt_date, endSetDate, 'gt');

                retFltr.push('((' + cancFltr.join(allRefs.terms.andFlrSep) + ')' + allRefs.terms.orFltrSep + '(' + usedFltr.join(allRefs.terms.andFlrSep) + '))');
                return retFltr.join(allRefs.terms.andFlrSep);
            },
            contractsFlds: function () {
                var retFlds = [];
                retFlds[0] = _objectUrbSelect(contractModel);
                retFlds[1] = _objectUrbSelect(opprtntModel, allRefs.joinOppr + '/'); // сделки
                retFlds[2] = _objectUrbSelect(paysModel, allRefs.joinPays + '/');    // платежи
                retFlds[3] = _objectUrbSelect(appartModel, allRefs.joinApps + '/');  // помещение

                return retFlds.join(allRefs.terms.commaSep);
            },
            contractsJoin: function () {
                var retJoin = [];
                retJoin[0] = allRefs.joinOppr;
                retJoin[1] = allRefs.joinPays;
                retJoin[2] = allRefs.joinApps;

                return retJoin.join(allRefs.terms.commaSep);
            },
            parseResultData: function (realData, dataArrayName, callMethod) {

                if (realData != '' && 'd' in realData && 'results' in realData.d && _isArrayFill(realData.d.results)) {

                    allRefs[dataArrayName] = allRefs[dataArrayName].concat(realData.d.results);

                    if ('__next' in realData.d && _isArrayFill(realData.d.__next)) {

                        _asyncReqst(_checkAjaxUrl(realData.d.__next), callMethod);

                        return false;
                    }
                }

                return true;
            },
            contractsCallAct: function (data) {
                /// <summary> Обработчик асинхронных данных действующих договоров
                /// </summary>
                if (allRefs.parseResultData(_setOrDefault(data), '_actcontrdata', allRefs.contractsCallAct))
                    allRefs.contractsGoAct = false;
            },
            contractsCallCanc: function (data) {
                /// <summary> Обработчик асинхронных данных отмененных договоров
                /// </summary>               
                if (allRefs.parseResultData(_setOrDefault(data), '_cancontrdata', allRefs.contractsCallCanc))
                    allRefs.contractsGoCanc = false;
            },
            contractsAsync: function (actPeriod, cancPeriod) {
                /// <summary> Получение данных договоров асинхронно двумя потоками: 1 - действующие (Act); 2 - расторгнутые (Canc)
                /// Отдельные периоды могут быть определены для двух потоков, но если период для расторгнутых и для действующих один и тот же - можно передать один аргумент-период.
                /// </summary>
                if (_setOrDefault(cancPeriod) == '') cancPeriod = actPeriod;

                for (var step = 0; step < 2; step++) {

                    var stepFltr = '';

                    if (step == 0) {
                        allRefs._actcontrdata = [];
                        allRefs.contractsGoAct = true;
                        stepFltr = allRefs.contractsFltrAct(actPeriod.finishDate, actPeriod.startDate);
                    }
                    else {
                        allRefs._cancontrdata = [];
                        allRefs.contractsGoCanc = true;
                        stepFltr = allRefs.contractFltrCanc(cancPeriod.finishDate, cancPeriod.startDate);
                    }

                    var stepUrl = _pathForAjax(contractModel['Entity'], _getServerUrl()) + '?' +
                                  '$select=' + allRefs.contractsFlds() + '&$orderby=CreatedOn desc&' +
                                  '$filter=' + stepFltr + '&' +
                                  '$expand=' + allRefs.contractsJoin();

                    _asyncReqst(stepUrl, (step == 0) ? allRefs.contractsCallAct : allRefs.contractsCallCanc);
                }
            },
            contracts: function (objPeriod) {
                /// <summary> Получение данных договоров, количеством свыше 250
                /// </summary>
                var contrFltr = allRefs.contractsFltrAlt(contractModel.urb_signdate, objPeriod.finishDate, objPeriod.startDate); // contractsFltr
                //var countFltr = '';
                var stpUrl = '';
                var stpCnt = 0;

                if (_setOrDefault(allRefs._contrData[objPeriod.periodName]) == '')
                    allRefs._contrData[objPeriod.periodName] = [];

                if (allRefs._contrData[objPeriod.periodName].length == 0)
                    while (true) {

                        var retrieveData = (stpCnt > 0 && stpUrl != '') ? _syncAjaxAlt(stpUrl) :
                        _syncRetrieve(_getServerUrl(), contractModel['Entity'], allRefs.contractsFlds(), contrFltr, allRefs.contractsJoin()); // , allRefs.joinCalc

                        if (retrieveData.d && _isArrayFill(retrieveData.d.results)) {
                            allRefs._contrData[objPeriod.periodName] = allRefs._contrData[objPeriod.periodName].concat(retrieveData.d.results);

                            if (typeof retrieveData.d.__next != 'undefined' && _isArrayFill(retrieveData.d.__next))
                                stpUrl = _checkAjaxUrl(retrieveData.d.__next);
                            else
                                break;
                        }
                        else
                            break;

                        stpCnt++;
                                                
                        //var retrieveData = _syncAjax(_getServerUrl(), contractModel['Entity'], allRefs.contractsFlds(),
                        //    contrFltr + countFltr, allRefs.contractsJoin()); //

                        //if (retrieveData.d && _isArrayFill(retrieveData.d.results)) {
                        //    allRefs._contrData[objPeriod.periodName] = allRefs._contrData[objPeriod.periodName].concat(retrieveData.d.results);

                        //    if (retrieveData.d.results.length < 250)
                        //        break;
                        //    else {
                        //        var stepDate = retrieveData.d.results[retrieveData.d.results.length - 1][contractModel.urb_cntrct_date];
                        //        var stepUid = retrieveData.d.results[retrieveData.d.results.length - 1][contractModel.urb_Id];

                        //        countFltr = ' ' + allRefs.terms.andFlrSep + ' ' + contractModel.urb_Id + " ne (guid'" + stepUid + "') " + allRefs.terms.andFlrSep + ' ' +
                        //            _snglFltr_DateComp(contractModel.urb_cntrct_date, new Date(stepDate.getFullYear(), stepDate.getMonth(), stepDate.getDate(),
                        //            stepDate.getHours(), stepDate.getMinutes(), stepDate.getSeconds()), 'lt');
                        //    }
                        //}
                        //else
                        //    break;
                    }
                
                return allRefs._contrData[objPeriod.periodName];
            },
            ratings: function () {
                var retrieveData = _syncAjax(_getServerUrl(), ratingModel['Entity'], _objectUrbSelect(ratingModel), _snglFltr_NotNull(ratingModel.urb_Id));

                return (retrieveData.d && _isArrayFill(retrieveData.d.results)) ? retrieveData.d.results : [];
            },
            getContractObj: function (objPeriod, contractRec) {
                /// <summary> Формирование объекта-контракта по модели
                /// </summary>
                var objContract = {};

                objContract.objPeriod = objPeriod;

                for (var prop in contractModel)
                    objContract[prop] = ObjFieldValue(prop, contractRec, contractModel);

                if (contractRec[allRefs.joinOppr])
                    for (var prop in opprtntModel)
                        if (prop != 'Entity')
                            objContract[prop] = ObjFieldValue(prop, contractRec[allRefs.joinOppr], opprtntModel);

                if (contractRec[allRefs.joinApps])
                    for (var prop in appartModel)
                        if (prop != 'Entity')
                            objContract[prop] = ObjFieldValue(prop, contractRec[allRefs.joinApps], appartModel);

                // TODO: зарегулировать через настройки с определением: по каким полям считать сумму, а по каким - макисмум или минимум
                // Данные о связанных - добавить в модель.
                if (contractRec[allRefs.joinPays] && _isArrayFill(contractRec[allRefs.joinPays].results)) {
                    var paySum = 0;

                    for (var loop = 0, lLngth = contractRec[allRefs.joinPays].results.length; loop < lLngth; loop++)
                        paySum += GetParseNum(contractRec[allRefs.joinPays].results[loop][paysModel.urb_pay_sum].Value);

                    objContract['urb_pay_sum'] = paySum;
                    objContract['urb_pay_date'] = contractRec[allRefs.joinPays].results[0][paysModel.urb_pay_date];
                }

                objContract['alert_color'] = ((_setOrDefault(GetParseNum(contractRec['urb_amount']), 0) - contractRec['urb_pay_sum']) > 1) ? 'red' : 'black';

                return objContract;
            },
            addNewAct: function (yearVal, mnthVal, contUid, valIsQuart) {
                var newAct = {};
                newAct[actModel['urb_year']] = _getOption(yearVal);
                newAct[actModel['urb_month']] = _getOption(mnthVal);
                newAct[actModel['urb_contract']] = _getLookup(contUid, allRefs.lookAttr['urb_contract']);
                newAct[actModel['urb_isquart']] = true;

                var retrievedAct = _createAjax(_getServerUrl(), actModel['Entity'], newAct);

                return (retrievedAct && retrievedAct.d) ? retrievedAct.d : null;
            },
            acts: function (yearVal, mnthVal, cntrUid) {
                var actsFltr = [];
                if (yearVal) actsFltr[0] = _snglFltr_OptionComp(actModel['urb_year'], yearVal);
                if (mnthVal) actsFltr[actsFltr.length] = _snglFltr_OptionComp(actModel['urb_month'], mnthVal);
                if (cntrUid) actsFltr[actsFltr.length] = _snglFltr_GuidEquals(actModel['urb_contract'] + '/Id', cntrUid);

                return allRefs._parseActs(allRefs._retrieveActs(actsFltr.join(' and ')));
            },
            actsHistory: function (cntrUid, currUid) {
                var actsFltr = [];

                actsFltr[0] = _snglFltr_GuidEquals(actModel['urb_contract'] + '/Id', cntrUid);
                actsFltr[1] = _snglFltr_GuidEquals(actModel['urb_Id'], currUid).replace('eq', 'ne');

                return allRefs._parseActs(allRefs._retrieveActs(actsFltr.join(' and ')));
            },
            _parseActs: function (actRecs) {
                var retActs = [];

                for (var step = 0, sLngth = actRecs.length; step < sLngth; step++) {
                    var stepAct = GetModelObject(actModel, actRecs[step]);

                    stepAct[allRefs.joinPref] = (allRefs.joinPref in actRecs[step]) ?
                        allRefs._parseActRecs(actRecs[step][allRefs.joinPref].results) : [];

                    retActs[retActs.length] = stepAct;
                }

                return retActs;
            },
            _parseActRecs: function (actJoinRecs, currModel) {
                var retActRecs = [];

                if (currModel == null || typeof currModel == 'undefined')
                    currModel = actrecModel;

                if (actJoinRecs) // нужно проверить, потому как из набора будет передан набор results, который вполне может быть неопределен
                    for (var step = 0, sLngth = actJoinRecs.length; step < sLngth; step++)
                        retActRecs[retActRecs.length] = GetModelObject(currModel, actJoinRecs[step]);

                return retActRecs;
            },
            _retrieveActs: function (actsFltr) {
                var actsSlct = [];
                actsSlct[0] = _objectUrbSelect(actModel);
                actsSlct[1] = _objectUrbSelect(actrecModel, allRefs.joinPref + '/');

                var actsSet = _syncAjax(_getServerUrl(), actModel['Entity'], actsSlct.join(','), actsFltr, allRefs.joinPref);

                return (actsSet.d && actsSet.d.results) ? actsSet.d.results : [];
            }
        };

        function UpdateCntrlName(prop) { return prop + allRefs.editCntrlPstfx; }

        function GetModelObject(currModel, srcObject) {
            /// <summary> Формирование объекта по модели из другого объекта
            /// </summary>
            var retObject = {};

            for (var prop in currModel) retObject[prop] = ObjFieldValue(prop, srcObject, currModel);

            return retObject;
        }

        function ObjFieldValue(prop, entObject, currModel) {
            /// <summary> Корректное присвоение значения атрибута
            /// </summary>
            var objFldName = currModel[prop];

            var existFld = (objFldName in entObject);

            var objField = existFld ? entObject[objFldName] : null;

            if (!existFld)
                return (objFldName == '-self-') ? _getLookup(entObject[currModel['urb_Id']], currModel['Entity'].toLowerCase()) :
                    (prop in allRefs.partyLoad) ? _getPartyValue(currModel[prop], entObject) : objFldName;
            else if (prop in allRefs.optsAttr) {
                var entFieldVal = _getPickValue(objField, allRefs.defaults[allRefs.optsAttr[prop]]);
                return (entFieldVal in allRefs[allRefs.optsAttr[prop]]) ?
                    allRefs[allRefs.optsAttr[prop]][entFieldVal] : _objectUrbArray(allRefs[allRefs.optsAttr[prop]])[0];
            }
            else if (prop in allRefs.moneyAttr)
                return (objField.Value) ? GetParseNum(objField.Value) : '';
            else return _setOrDefault(objField);
        }

        function FieldActualValue(prop, entObject, editMode) {
            if (prop in allRefs.optsAttr) return (editMode) ? _getCheckVal(prop, entObject) : entObject;
            else if (prop in allRefs.dateAttr) return (editMode || entObject === '') ? entObject : entObject.toLocaleDateString();
            else if (prop in allRefs.lookAttr) return (entObject.Name) ? entObject.Name : '';
            else return _setOrDefault(entObject);
        }

        function FieldEditControl(prop) {
            var cntrlType = (prop in allRefs.optsAttr) ? 'kendoComboBox' :
            (prop in allRefs.numsAttr) ? 'kendoNumericTextBox' :
            (prop in allRefs.lookAttr) ? 'kendoAutoComplete' : '';

            return (cntrlType != '') ? $('#' + UpdateCntrlName(prop)).data(cntrlType) : null;
        }

        function ObjFieldSetControl(prop, entObject, editMode) {
            var actualValue = FieldActualValue(prop, entObject, editMode);

            if (editMode) {
                var editCntrl = FieldEditControl(prop);

                if (editCntrl)
                    editCntrl.value(actualValue);
                else if (_getElemById(UpdateCntrlName(prop)))
                    _getElemById(UpdateCntrlName(prop)).value = actualValue;
            }
            else
                _setTextValue(prop, actualValue);
        }

        function forceYears() {
            var currDate = new Date();
            var minYear = 2015,
                maxYear = currDate.getFullYear();

            for (var prop in allRefs.years)
                if (allRefs.years[prop] != minYear)
                    minYear = allRefs.years[prop];

            for (var step = minYear + 1; step <= maxYear; step++)
                if (!(step in allRefs.years))
                    allRefs.years[step] = step;
        }

        $(document).ready(function ($) {
            kendo.culture("ru-RU");
            //forceMonthVals();
            forceYears();

            treeSource = new kendo.data.HierarchicalDataSource({
                data: _objectUrbArray(allRefs.years),
                schema: {
                    parse: function (data) {
                        var retArray = [];

                        for (var step = 0, sLngth = data.length; step < sLngth; step++) {

                            retArray[step] = {};
                            retArray[step].value = data[step].value;
                            retArray[step].hasChildren = true;
                            retArray[step].MonthTotals = ParseYear(data[step].value);
                            retArray[step].children = 'MonthTotals';
                        }

                        return retArray;
                    }
                }
            });

            $("#vertical").kendoSplitter({
                orientation: 'vertical',
                panes: [{ collapsible: false, size: "31px" }, { collapsible: false, resizable: false }]
            });

            $("#horiz_split").kendoSplitter({
                orientation: 'horizontal',
                panes: [{ collapsible: false, size: "9%" }, { collapsible: false, resizable: true }]
            });

            $("#urb_start_ent").kendoDatePicker({
                format: "dd.MM.yyyy",
                culture: "ru-RU"
            });

            $("#urb_finish_ent").kendoDatePicker({
                format: "dd.MM.yyyy",
                culture: "ru-RU"
            });

            AutoCompleteInit('districtAdd', 'urb_name', 'startswith', 'Введите название района...', 2, 'urb_region');
            AutoCompleteInit('subwayAdd', 'urb_name', 'startswith', 'Введите название станции...', 2, 'urb_metro');
            AutoCompleteInit('streetAdd', 'urb_name', 'contains', 'Введите название улицы...', 3, 'urb_street');
            AutoCompleteInit('residenceAdd', 'urb_name', 'contains', 'Введите название ЖК...', 2, 'urb_residence');
            AutoCompleteInit('urb_currency_ent', 'currencyname', 'startswith', 'Euro-US Dollar-рубль...', 1, 'TransactionCurrency');

            ComboBoxInit('rprt_kinds', 'text', 'value', _objectUrbArray(allRefs['repPrds']), 'contains', true, 0);
            ComboBoxInit('sort_kinds', 'text', 'value', _objectUrbArray(allRefs['srtOrdrs']), 'contains', true, 0);

            // - - - К Н О П К И - - -
            $('#upd_refresh').kendoButton({
                spriteCssClass: "k-icon k-i-refresh"
            });
            $('#upd_refresh').click(gloUpdate);
            $('#save_client').kendoButton();
            $('#save_client').click(saveClientRec);
            $('#prnt_act').kendoButton();
            $('#prnt_act').click(getWordDoc);
            $('#fix_rates').kendoButton({
                enable: false
            }); //prnt_act
            $('#fix_rates').click(getFixRates);
            //$('#var_apps').kendoButton();
            //$('#var_apps').click(saveVariantApps);
            $('#go_search').kendoButton();
            $('#go_search').click(nextSearchRes);
            $('#add_client').kendoButton();
            $('#add_client').click(addNewClient);
            $('#excel_report').kendoButton({
                imageUrl: "http://crm6/_imgs/ico/16_print.gif"
            });
            $('#excel_report').click(excelReport);
            //$('#search_word').keypress(nextSearchRes);

            AutoCompleteInit('search_word', 'FullName', 'contains', 'Искать клиента по имени...', 3, 'Contact');

            var trview = $("#treeview").kendoTreeView({
                dataTextField: ["value", "text", "Nodename"],
                dataSource: treeSource,
                select: onTreeSelect
            }).data("kendoTreeView");

            getStartReport();

        }).ajaxSend(function (e, jqxhr, settings) {
            if (~settings.url.toLowerCase().indexOf("XRMServices/2011/OrganizationData.svc".toLowerCase())) {
                jqxhr.setRequestHeader("Accept", "application/json");
            }
        });

        prevSrchUid = '';
        selctAppData = [];
        autoCompData = {};
        reportRootData = [];
        reportData = [];
        reportTotals = {};

        function excelReport(e) {
            var gridElement = $('#reportGrid'),
                printableContent = '',
                win = window.open(), //'', '', 'width=800, height=500'
                doc = win.document.open();

            var htmlStart =
                    '<!DOCTYPE html>' +
                    '<html>' +
                    '<head>' +
                    '<meta charset="utf-8" />' +
                    '<title>Форма для печати</title>' +
                    '<link href="http://kendo.cdn.telerik.com/' + kendo.version + '/styles/kendo.common.min.css" rel="stylesheet" /> ' +
                    '<style>' +
                    'html { font: 11px verdana; }' +
                    '.k-grid { border-top-width: 0;}' +
                    '.k-grid, .k-grid-content { height: auto !important; }' +
                    '.k-grid-content { overflow: visible !important; }' +
                    'div.k-grid table { table-layout: auto; width: 100% !important; }' +
                    '.k-grid .k-grid-header th { border-top: 1px solid; }' +
                    '.k-grid-toolbar, .k-grid-pager > .k-link { display: none; }' +
                    '.k-alt td { border-top: silver 1px solid !important; border-bottom: silver 1px solid !important; }' +
                    '.k-group-cell { padding-left: 0 !important; padding-right: 0 !important; }' +
                    '.k-grid td { border-left-style: none !important; }' +
                    '</style>' +
                    '</head>' +
                    '<body>';

            var htmlEnd =
                    '</body>' +
                    '</html>';

            var gridHeader = gridElement.children('.k-grid-header');
            if (gridHeader[0]) {
                var thead = gridHeader.find('thead').clone().addClass('k-grid-header');
                printableContent = gridElement
                    .clone()
                        .children('.k-grid-header').remove()
                    .end()
                        .children('.k-grid-content')
                            .find('table')
                                .first()
                                    .children('tbody').before(thead)
                                .end()
                            .end()
                        .end()
                    .end()
                    .children('.k-grouping-header').remove()
                    .end()[0].outerHTML;
            } else {
                printableContent = gridElement.clone()[0].outerHTML;
            }

            doc.write(htmlStart + printableContent + htmlEnd);
            //doc.close();
            //win.location.reload();
            win.focus();
            win.print();

            //var template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head><body><table>{table}</table></body></html>';
            //var base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) };
            //var format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) };

            //var gridHeader = gridElement.children('.k-grid-header');
            //if (gridHeader[0]) {
            //    printableContent = '<table>' + gridElement.find('table').children('tbody')[0].outerHTML + '</table>';
            //} else {
            //    printableContent = gridElement.clone()[0].outerHTML;
            //}

            //var ctx = { worksheet: 'Worksheet', table: printableContent };
            //var uri = 'data:application/octet-stream;base64,';

            //saveAs(uri + base64(format(template, ctx)), 'filename.xlsx');

            //e.preventDefault();
        }

        function gloUpdate() {
            /// <summary> Метод получения обновленных данных договоров с ожиданием результатов асинхронного запроса
            /// </summary>
            var nowDate = new Date();

            allRefs.contractsAsync(allRefs.PeriodObject(nowDate.getFullYear(), nowDate.getMonth()));
            
            var timerCount = 0;

            setTimeout(function goFor() {
                timerCount++;

                if (timerCount < 200 && (allRefs.contractsGoAct || allRefs.contractsGoCanc))
                    setTimeout(goFor, 100);
                else
                    recsAwait();
            }, 100);
        }

        function recsAwait() {
            
            var stepDat = 0;
        }

        function getFixRates() {
            if (!_isArrayFill(reportData)) return;

            for (var step = 0, sLngth = reportData.length; step < sLngth; step++) {
                if (typeof reportData[step].manRate == 'undefined' || reportData[step].manRate == null || reportData[step].manRate == 0)
                    continue;

                var updtData = {};
                updtData['mtr_bonus_rate' + (reportData[step].halfManager && typeof reportData[step].baseRecord == 'undefined' ? '_co' : '')] =
                    kendo.toString(reportData[step].manRate, '#.##########').replace(',', '.');
                updtData['mtr_bonus_percent' + (reportData[step].halfManager && typeof reportData[step].baseRecord == 'undefined' ? '_co' : '')] =
                    kendo.toString(reportData[step].manPerc, '#.##########').replace(',', '.');

                _updateAjax(_getServerUrl(), contractModel['Entity'], reportData[step].orderUid, updtData);
            }

            alert('Коэффициенты зачислены в данные договоров');
        }

        function getStartReport() {
            $('#reportGrid').kendoGrid({
                groupable: true,
                resizable: true,
                dataBound:function(o){
                    var g = $("#reportGrid").data("kendoGrid");

                    for (var i = 0; i < 10; i++) // g.columns.length
                        g.showColumn(i);
                    
                    $("div.k-group-indicator").each(function(i, v){
                        g.hideColumn($(v).data("field"));
                    });
        
                },
                dataSource: {
                    data: reportData,
                    sort: { field: "orderDate", dir: "desc" },
                    group: {
                        field: "strPeriod",
                        dir: "desc",
                        aggregates:
                                [
                                    { field: "orderNo", aggregate: "count" },
                                    { field: "buildObject", aggregate: "count" },
                                    { field: "objSeller", aggregate: "count" },
                                    { field: "ManagerName", aggregate: "count" },
                                    { field: "strPeriod", aggregate: "count" },
                                    { field: "agreeAmount", aggregate: "sum" },
                                    { field: "payAmount", aggregate: "sum" },
                                    { field: "saleAmount", aggregate: "sum" },
                                    { field: "bonusAmount", aggregate: "sum" },
                                    { field: 'areaSquare', aggregate: 'sum' },
                                    { field: 'calculAmount', aggregate: 'sum' }
                                ]
                    }
                },
                columns: [
                            {
                                field: "orderNo",
                                title: "№ договора",
                                width: 150,
                                template: "<a href='javascript:void(0)' onclick='window.open(&quot;http://crm6/metrium/userdefined/edit.aspx?etc=1088&id=%7b${orderUid}%7d&quot;, &quot;_blank&quot;, &quot;location=no,menubar=no,status=no,toolbar=no,resizable=1,top=45,left=215,width=920,height=785&quot;, false)'>#=orderNo#</a>",
                                aggregates: ["count"],
                                groupFooterTemplate: "Кол-во: #=count#"
                            },
                            {
                                field: "orderDate",
                                title: "Дата договора",
                                width: 90,
                                template: "#= (orderDate != '') ? kendo.toString(orderDate, 'dd.MM.yyyy') : ' ' #",
                                groupHeaderTemplate: "Дата договора: #=kendo.toString(value, 'dd.MM.yyyy')#"
                            },
                            {
                                field: "buildObject",
                                title: "Объект застройки",
                                aggregates: ["count"],
                                width: 140,
                                groupHeaderTemplate: "Объект: #=value + ' (' + count + ')'#"
                            }, // lineType
                            {
                                field: 'lineType',
                                title: 'Мотивация',
                                width: 35
                            },
                            {
                                field: 'appType',
                                title: 'Тип помещения',
                                width: 72
                            },
                            {
                                field: "objSeller",
                                title: "Правообладатель",
                                width: 102,
                                aggregates: ["count"],
                                groupHeaderTemplate: "Правообладатель: #=value + ' (' + count + ')'#"
                            },
                            {
                                field: "Customer",
                                title: "Клиент",
                                template: "#= getViewName(Customer) #",
                                width: 110,
                                groupHeaderTemplate: "Клиент: #=getViewName(value) + ' (' + count + ')'#"
                            },
                            {
                                field: "ManagerName",
                                title: "Менеджер",
                                width: 90,
                                aggregates: ["count"],
                                groupHeaderTemplate: "Менеджер: #=value + ' (' + count + ')'#"
                            },
                            {
                                field: "halfManagerName",
                                title: "со-Менеджер (50%)",
                                aggregates: ["count"],
                                width: 90,
                                template: "#= (halfManager == null) ? ' ' : halfManagerName #",
                                groupHeaderTemplate: "Менеджер 2: #=value + ' (' + count + ')'#"
                            },
                            {
                                field: "payType",
                                title: "Форма оплаты",
                                width: 60
                            },
                            {
                                field: "saleAmount",
                                title: "Стоимость ДДУ",
                                width: 128,
                                template: "#= (saleAmount == 0) ? ' ' : kendo.toString(saleAmount, '0.00') #",
                                attributes: { style: "text-align: right;" },
                                aggregates: ["sum"],
                                groupFooterTemplate: "#= (sum > 0) ? kendo.toString(sum, 'n2') : ' ' #"
                            },
                            {
                                field: "agreeAmount",
                                title: "Стоимость договора",
                                width: 114,
                                template: "#= (agreeAmount == 0) ? ' ' : kendo.toString(agreeAmount, '0.00') #",
                                attributes: { style: "text-align: right;" },
                                aggregates: ["sum"],
                                groupFooterTemplate: "#= (sum > 0) ? kendo.toString(sum, 'n2') : ' ' #"
                            },
                            {
                                field: "payDate",
                                title: "Дата оплаты",
                                width: 90,
                                template: "#= (payDate != '') ? kendo.toString(payDate, 'dd.MM.yyyy') : ' ' #"
                            },
                            {
                                field: "payAmount",
                                title: "Сумма оплат",
                                width: 114,
                                template: "#= (payAmount == 0) ? ' ' : kendo.toString(payAmount, '0.00') #",
                                attributes: {
                                    style: "text-align: right; color: #= ((agreeAmount - payAmount) > 1) ? 'red' : 'black' #"
                                },
                                aggregates: ["sum"],
                                groupFooterTemplate: "#= (sum > 0) ? kendo.toString(sum, 'n2') : ' ' #"
                            },
                            {
                                field: 'areaSquare',
                                title: 'Площадь, м²',
                                width: 90,
                                template: "#= (areaSquare == 0) ? ' ' : kendo.toString(areaSquare, '0.00') #",
                                attributes: {
                                    style: "text-align: right; color: #= (areaSquare < 0) ? 'red' : 'black' #"
                                },
                                aggregates: ["sum"],
                                groupFooterTemplate: "#= (sum > 0) ? kendo.toString(sum, 'n2') : ' ' #"
                            },
                            {
                                field: 'calculAmount',
                                title: 'Расч. стоимость',
                                width: 122,
                                template: "#= (calculAmount == 0) ? ' ' : kendo.toString(calculAmount, '0.00') #",
                                aggregates: ["sum"],
                                attributes: {
                                    style: "text-align: right; color: #= (calculAmount < 0) ? 'red' : 'black' #"
                                },
                                groupFooterTemplate: "#= (sum > 0) ? kendo.toString(sum, 'n2') : ' ' #"
                            },
                            {
                                field: 'act1Date',
                                title: 'Дата акта по 1 этапу',
                                width: 90,
                                template: "#= (act1Date != '') ? kendo.toString(act1Date, 'dd.MM.yyyy') : ' ' #",
                                hidden: true
                            },
                            {
                                field: "manRate",
                                title: "Коэффициент",
                                width: 62,
                                template: "#= (typeof manRate == 'undefined') ? '' : kendo.toString(manRate, '0.000') #",
                                hidden: true
                            },
                            {
                                field: "manPerc",
                                title: "% выполнения",
                                width: 70,
                                template: "#= (typeof manPerc == 'undefined') ? '' : kendo.toString(manPerc, '0') #",
                                hidden: true
                            },
                            {
                                field: "objPlan",
                                title: "План. сумма",
                                width: 110,
                                template: "#= (typeof objPlan == 'undefined') ? '' : kendo.toString(objPlan, '0') #",
                                hidden: true
                            },
                            {
                                field: "objRate",
                                title: "За долю",
                                width: 62,
                                template: "#= (typeof objRate == 'undefined') ? '' : kendo.toString(objRate, '0.00') #",
                                hidden: true
                            },
                            {
                                field: 'bonusAmount',
                                title: 'Бонус',
                                width: 122,
                                template: "#= (typeof bonusAmount == 'undefined' || bonusAmount == 0) ? ' ' : kendo.toString(bonusAmount, '0.00') #",
                                aggregates: ["sum"],
                                groupFooterTemplate: "#= (sum > 0) ? kendo.toString(sum, 'n2') : ' ' #",
                                hidden: true
                            },
                            {
                                field: "strPeriod",
                                title: "Период: ",
                                aggregates: ["count"],
                                groupHeaderTemplate: "Период: #=value + ' (' + count + ')'#"//,
                                //hidden: true
                            }
                ]
            });
        }

        function AddRepLineQuart(periodObj, contrArray) {

            var newRepLine = {};

            var paySum = 0,
                statCod = _setOrDefault(contrArray['StatusCode'].Value, 0),
                sumRate = _setOrDefault(GetParseNum(contrArray['mtr_bonus_rate']), 0);

            var payDate = '',
                ordrDate = _setOrDefault(_dateReviver(0, contrArray['mtr_date_signed'])),
                modifDate = _dateReviver(0, contrArray['ModifiedOn']); // не может быть пустым - отбор в запросе содержит условие

            if (contrArray[allRefs.joinPays] && _isArrayFill(contrArray[allRefs.joinPays].results)) {
                for (var loop = 0, lLngth = contrArray[allRefs.joinPays].results.length; loop < lLngth; loop++)
                    paySum += GetParseNum(contrArray[allRefs.joinPays].results[loop][paysModel.urb_pay_sum].Value);

                payDate = _dateReviver(0, contrArray[allRefs.joinPays].results[0][paysModel.urb_pay_date]);
            }

            var fltrDate = new Date(periodObj.finishDate.getFullYear(), periodObj.finishDate.getMonth(), periodObj.finishDate.getDate(), 23, 59, 59),
                    bgnDate = new Date(periodObj.startDate.getFullYear(), periodObj.startDate.getMonth(), periodObj.startDate.getDate(), 23, 59, 59);

            if (statCod == 4 && sumRate == 0) return null;

            var corrSqre = (contrArray[allRefs.joinApps]) ? contrArray[allRefs.joinApps]['snrlt_spacedesign'] : 0,
                corrCalc = (statCod == 4 && modifDate > bgnDate && modifDate <= fltrDate) ? -1 : 1;

            newRepLine.orderUid = contrArray[contractModel['urb_Id']];
            newRepLine.strPeriod = periodObj.periodName + periodObj.yearValue;
            newRepLine.payDate = _setOrDefault(payDate);
            newRepLine.payAmount = _setMoneyValue(GetParseNum(paySum));
            newRepLine.act1Date = _setOrDefault(_dateReviver(0, contrArray['mtr_act_date1']));
            newRepLine.act1Value = _setOrDefault(GetParseNum(contrArray['mtr_act_amount1']), 0);
            newRepLine.saleAmount = (contrArray[allRefs.joinOppr]) ? _setMoneyValue(GetParseNum(contrArray[allRefs.joinOppr]['mtr_dpsumdiscount'].Value), 0) : 0;
            newRepLine.agreeAmount = _setMoneyValue(GetParseNum(contrArray['snrlt_totalamount'].Value), 0);
            newRepLine.calculAmount = ((contrArray['mtr_apartmentid'].Id) ? GetParseNum(newRepLine.saleAmount) + GetParseNum(newRepLine.agreeAmount) : 0) * corrCalc;
            newRepLine.Manager = (contrArray[allRefs.joinOppr]) ? contrArray[allRefs.joinOppr]['OwnerId'].Name : '';
            newRepLine.ManagerName = getViewName(newRepLine.Manager);
            newRepLine.ManagerRate = sumRate;
            newRepLine.ManagerPerc = _setOrDefault(GetParseNum(contrArray['mtr_bonus_percent']), 0);
            newRepLine.Customer = contrArray['CustomerId'].Name;
            newRepLine.objSeller = (contrArray[allRefs.joinOppr]) ? contrArray[allRefs.joinOppr]['snrlt_organizationid'].Name : '';
            newRepLine.buildObject = (contrArray[allRefs.joinOppr]) ?
                ((~contrArray[allRefs.joinOppr]['snrlt_buildinggroupid'].Name.indexOf('Фили')) ? contrArray[allRefs.joinOppr]['snrlt_buildinggroupid'].Name.replace(' - 2', '') :
                (~contrArray[allRefs.joinOppr]['snrlt_buildinggroupid'].Name.indexOf('Эко Видное')) ? contrArray[allRefs.joinOppr]['snrlt_buildinggroupid'].Name.replace(' 2.0', '') :
                _setOrDefault(contrArray[allRefs.joinOppr]['snrlt_buildinggroupid'].Name)) : '';
            newRepLine.orderDate = new Date(ordrDate.getFullYear(), ordrDate.getMonth(), ordrDate.getDate(), 12, 0, 0);
            newRepLine.orderNo = contrArray['mtr_namewithoutspace'];
            newRepLine.actDate = _setOrDefault(_dateReviver(0, contrArray['mtr_act_date1']));
            newRepLine.lineType = (contrArray['mtr_apartmentid'].Id) ? 'по площади' : 'поштучно';
            newRepLine.appType = (contrArray['mtr_apartmentid'].Id) ? ((contrArray[allRefs.joinApps]) ? allRefs.appTypes[_getPickValue(contrArray[allRefs.joinApps]['snrlt_premisestype'], allRefs.defaults['appTypes'])] :
                allRefs.appTypes[allRefs.defaults['appTypes']]) : (contrArray['mtr_parkingid'].Id) ? 'Машиноместо' : 'Кладовая';
            newRepLine.areaSquare = corrSqre * corrCalc;
            newRepLine.payType = (contrArray[allRefs.joinOppr] && contrArray[allRefs.joinOppr]['mtr_payment'] && contrArray[allRefs.joinOppr]['mtr_payment'].Value) ?
                allRefs.payTypes[contrArray[allRefs.joinOppr]['mtr_payment'].Value] : allRefs.payTypes[allRefs.defaults['payTypes']];
            newRepLine.halfManager = (contrArray[allRefs.joinOppr] && contrArray[allRefs.joinOppr]['mtr_manager2id'] && contrArray[allRefs.joinOppr]['mtr_manager2id'].Id != null) ?
                contrArray[allRefs.joinOppr]['mtr_manager2id'].Name : null;
            newRepLine.halfManagerName = getViewName(newRepLine.halfManager);
            newRepLine.halfManagerRate = _setOrDefault(GetParseNum(contrArray['mtr_bonus_rate_co']), 0);
            newRepLine.halfManagerPerc = _setOrDefault(GetParseNum(contrArray['mtr_bonus_percent_co']), 0);

            return newRepLine;
        }

        function AddRepLine(periodObj, contrArray) {
            var newRepLine = {};
            var paySum = 0;
            var payDate = '',
                ordrDate = _setOrDefault(contrArray['mtr_date_signed']); // не может быть пустым - отбор в запросе содержит условие

            if (contrArray[allRefs.joinPays] && _isArrayFill(contrArray[allRefs.joinPays].results)) {
                for (var loop = 0, lLngth = contrArray[allRefs.joinPays].results.length; loop < lLngth; loop++)
                    paySum += GetParseNum(contrArray[allRefs.joinPays].results[loop][paysModel.urb_pay_sum].Value);

                payDate = contrArray[allRefs.joinPays].results[0][paysModel.urb_pay_date];
            }

            var fltrDate = new Date(periodObj.finishDate.getFullYear(), periodObj.finishDate.getMonth(), periodObj.finishDate.getDate(), 23, 59, 59),
                    bgnDate = new Date(periodObj.startDate.getFullYear(), periodObj.startDate.getMonth(), periodObj.startDate.getDate(), 23, 59, 59);

            //if (paySum == 0 || contrArray['mtr_apartmentid'].Id != null) return null;

            var corrSqre = (contrArray[allRefs.joinApps]) ? contrArray[allRefs.joinApps]['snrlt_spacedesign'] : 0,
                corrCalc = (_setOrDefault(contrArray['StatusCode'].Value, 0) == 4 && contrArray['ModifiedOn'] > bgnDate && contrArray['ModifiedOn'] <= fltrDate) ? -1 : 1;

            newRepLine.orderUid = contrArray[contractModel['urb_Id']];
            newRepLine.strPeriod = '[' + periodObj.periodName + '] ' + periodObj.monthName + ' ' + periodObj.yearValue;
            newRepLine.payDate = _setOrDefault(payDate);
            newRepLine.payAmount = _setMoneyValue(GetParseNum(paySum));
            newRepLine.act1Date = _setOrDefault(contrArray['mtr_act_date1']);
            newRepLine.act1Value = _setOrDefault(GetParseNum(contrArray['mtr_act_amount1']), 0);
            newRepLine.saleAmount = (contrArray[allRefs.joinOppr]) ? _setMoneyValue(GetParseNum(contrArray[allRefs.joinOppr]['mtr_dpsumdiscount'].Value), 0) : 0;
            newRepLine.agreeAmount = _setMoneyValue(GetParseNum(contrArray['snrlt_totalamount'].Value), 0);
            newRepLine.calculAmount = ((contrArray['mtr_apartmentid'].Id) ? GetParseNum(newRepLine.saleAmount) + GetParseNum(newRepLine.agreeAmount) : 0) * corrCalc;
            newRepLine.Manager = (contrArray[allRefs.joinOppr]) ? contrArray[allRefs.joinOppr]['OwnerId'].Name : '';
            newRepLine.ManagerName = getViewName(newRepLine.Manager);
            newRepLine.ManagerRate = _setOrDefault(GetParseNum(contrArray['mtr_bonus_rate']), 0);
            newRepLine.ManagerPerc = _setOrDefault(GetParseNum(contrArray['mtr_bonus_percent']), 0);
            newRepLine.Customer = contrArray['CustomerId'].Name;
            newRepLine.objSeller = (contrArray[allRefs.joinOppr]) ? contrArray[allRefs.joinOppr]['snrlt_organizationid'].Name : '';
            newRepLine.buildObject = (contrArray[allRefs.joinOppr]) ?
                ((~contrArray[allRefs.joinOppr]['snrlt_buildinggroupid'].Name.indexOf('Фили')) ? contrArray[allRefs.joinOppr]['snrlt_buildinggroupid'].Name.replace(' - 2', '') :
                (~contrArray[allRefs.joinOppr]['snrlt_buildinggroupid'].Name.indexOf('Эко Видное')) ? contrArray[allRefs.joinOppr]['snrlt_buildinggroupid'].Name.replace(' 2.0', '') :
                _setOrDefault(contrArray[allRefs.joinOppr]['snrlt_buildinggroupid'].Name)) : '';
            newRepLine.orderDate = new Date(ordrDate.getFullYear(), ordrDate.getMonth(), ordrDate.getDate(), 12, 0, 0);
            newRepLine.orderNo = contrArray['mtr_namewithoutspace'];
            newRepLine.actDate = _setOrDefault(contrArray['mtr_act_date1']);
            newRepLine.lineType = (contrArray['mtr_apartmentid'].Id) ? 'по площади' : 'поштучно';
            newRepLine.appType = (contrArray['mtr_apartmentid'].Id) ? ((contrArray[allRefs.joinApps]) ? allRefs.appTypes[_getPickValue(contrArray[allRefs.joinApps]['snrlt_premisestype'], allRefs.defaults['appTypes'])] :
                allRefs.appTypes[allRefs.defaults['appTypes']]) : (contrArray['mtr_parkingid'].Id) ? 'Машиноместо' : 'Кладовая';
            newRepLine.areaSquare = corrSqre * corrCalc;
            newRepLine.payType = (contrArray[allRefs.joinOppr] && contrArray[allRefs.joinOppr]['mtr_payment'] && contrArray[allRefs.joinOppr]['mtr_payment'].Value) ?
                allRefs.payTypes[contrArray[allRefs.joinOppr]['mtr_payment'].Value] : allRefs.payTypes[allRefs.defaults['payTypes']];
            newRepLine.halfManager = (contrArray[allRefs.joinOppr] && contrArray[allRefs.joinOppr]['mtr_manager2id'] && contrArray[allRefs.joinOppr]['mtr_manager2id'].Id != null) ?
                contrArray[allRefs.joinOppr]['mtr_manager2id'].Name : null;
            newRepLine.halfManagerName = getViewName(newRepLine.halfManager);
            newRepLine.halfManagerRate = _setOrDefault(GetParseNum(contrArray['mtr_bonus_rate_co']), 0);
            newRepLine.halfManagerPerc = _setOrDefault(GetParseNum(contrArray['mtr_bonus_percent_co']), 0);

            return newRepLine;
        }

        function getViewName(realName) {
            if (!_isArrayFill(realName)) return '';

            var arrNamePrts = realName.split(' ');

            return (_isArrayFill(arrNamePrts) && arrNamePrts.length == 2) ? arrNamePrts[1] + ' ' + arrNamePrts[0] : realName;
        }

        function forceMonthVals(modeIndx) {
            /// <summary> Формирование массива периодов для отчета: 0 - понедельно; 1 - помесячно;
            /// datNowPl.getDay() - день недели, где понедельник == 1 </summary>
            var datNow = new Date();
            var datNowPl = new Date(datNow.getFullYear(), datNow.getMonth(), datNow.getDate(), 0, 0, 1);
            var getIndx = (modeIndx && modeIndx == 1) ? 1 : datNowPl.getDate() - (datNowPl.getDay() - 1);
            datNowPl.setDate(getIndx);

            var frcLine = {};
            frcLine.dateOvr = new Date(datNow.getFullYear(), datNow.getMonth(), datNow.getDate(), 23, 59, 59);
            frcLine.dateBeg = setDateFrc(datNowPl);

            if (frcLine.dateOvr > frcLine.dateBeg)
                reportRootData[reportRootData.length] = frcLine;

            datNowPl.setDate(((modeIndx && modeIndx == 1) ? 1 : datNowPl.getDate()) - 1);

            for (var step = 0, sLngth = (modeIndx && modeIndx == 1) ? 3 : 5 ; step < sLngth; step++) {
                var stepLine = {};
                var stepDate = setDateFrc(datNowPl);
                stepLine.dateOvr = new Date(stepDate.getFullYear(), stepDate.getMonth(), stepDate.getDate(), 23, 59, 59);
                datNowPl.setDate((modeIndx && modeIndx == 1) ? 1 : datNowPl.getDate() - 6);
                stepLine.dateBeg = setDateFrc(datNowPl);

                reportRootData[reportRootData.length] = stepLine;

                datNowPl.setDate(((modeIndx && modeIndx == 1) ? 1 : datNowPl.getDate()) - 1);
            }
        }

        var templateData = {};
        selectedAct = null;

        function tmplBlob2Base(url) {

            if (url in templateData) return;

            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.responseType = 'blob';

            xhr.onload = function () {
                var blobTmpl = xhr.response;

                var reader = new FileReader();
                reader.onloadend = function () {
                    templateData[url] = reader.result;
                };
                reader.readAsArrayBuffer(blobTmpl);
            }
            xhr.send();
        }

        function getWordDoc() {

            if (selectedAct == null) return;

            var W = openXml.W;
            var XElement = Ltxml.XElement;
            var XAttribute = Ltxml.XAttribute;

            var doc = new openXml.OpenXmlPackage(templateData[selectedAct.url]);

            var xDoc = doc.mainDocumentPart().getXDocument();

            var docxDescs = xDoc.descendants(W.t).where('a => a.value.indexOf("#:") >= 0').toArray();

            for (var track = 0, trLngth = docxDescs.length; track < trLngth; track++) {
                var updtdFlag = false;
                var attrArr = docxDescs[track].value.replace(' ', '').replace('-', '').split('#:');

                for (var cycl = 0, clLngth = attrArr.length; cycl < clLngth; cycl++)
                    if (attrArr[cycl] != '' && (attrArr[cycl] in selectedAct)) {
                        docxDescs[track].value = docxDescs[track].value.replace('#:', '').replace(attrArr[cycl],
                            (attrArr[cycl] in allRefs.dateAttr) ? selectedAct[attrArr[cycl]].toLocaleDateString() :
                            kendo.toString(_setOrDefault(GetParseNum(selectedAct[attrArr[cycl]])), ((~attrArr[cycl].indexOf('_units')) ? '#' : 'n2')) +
                            ((~attrArr[cycl].indexOf('_sum')) ? ' (' + number_to_string(GetParseNum(selectedAct[attrArr[cycl]])) + ')' : ''));
                        updtdFlag = true;
                    }
                    else if (attrArr[cycl] != '' && ~attrArr[cycl].indexOf('tbl_')) { // apparts; flats; garages
                        var tGroupName = attrArr[cycl].replace('tbl_', 'urb_').replace('_quart', '');
                        tGroupName = tGroupName.substr(0, tGroupName.length - 1);

                        var recsTbl = (~attrArr[cycl].indexOf('_quart')) ? selectedAct['quarter_recs'] : selectedAct[allRefs.joinPref];
                        var currCntr = 0;

                        if (tGroupName in allRefs.totalGroups) {

                            var tblPr = new XElement(W.tblPr,
                            new XElement(W.tblStyle, new XAttribute(W.val, "TableGrid")),
                            new XElement(W.tblW, new XAttribute(W._w, 0), new XAttribute(W.type, "auto")),
                            new XElement(W.tblLook,
                                new XAttribute(W.val, "04A0"),
                                new XAttribute(W.firstRow, 1),
                                new XAttribute(W.lastRow, 0),
                                new XAttribute(W.firstColumn, 1),
                                new XAttribute(W.lastColumn, 0),
                                new XAttribute(W.noHBand, 0),
                                new XAttribute(W.noVBand, 1)));

                            var tblGrid = new XElement(W.tblGrid,
                                            new XElement(W.gridCol, new XAttribute(W._w, 325)),
                                            new XElement(W.gridCol, new XAttribute(W._w, 3150)),
                                            new XElement(W.gridCol, new XAttribute(W._w, 1823)),
                                            new XElement(W.gridCol, new XAttribute(W._w, 1227)),
                                            new XElement(W.gridCol, new XAttribute(W._w, 1796)),
                                            new XElement(W.gridCol, new XAttribute(W._w, 1796)));

                            var currTblTotalSum = 0;
                            var docxTblRows = [];

                            for (var step = 0, sLngth = recsTbl.length; step < sLngth; step++)
                                if (recsTbl[step][allRefs.totalAttr.urb_sum] == allRefs.totalGroups[tGroupName]) {
                                    currCntr++;

                                    var c1 = docxTblRow(currCntr, 325),
                                        c2 = docxTblRow(recsTbl[step]['urb_client'], 3150),
                                        c3 = docxTblRow(recsTbl[step]['urb_number'], 1823),
                                        c4 = docxTblRow(kendo.toString(recsTbl[step]['urb_date'], 'd'), 1227),
                                        c5 = docxTblRow(kendo.toString(_setOrDefault(GetParseNum(recsTbl[step]['urb_agree_sum'])), 'n2'), 1796),
                                        c6 = docxTblRow(kendo.toString(_setOrDefault(GetParseNum(recsTbl[step]['urb_sum'])), 'n2'), 1796);

                                    currTblTotalSum = currTblTotalSum + GetParseNum(recsTbl[step]['urb_sum']);

                                    docxTblRows[currCntr] = new XElement(W.tr, c1, c2, c3, c4, c5, c6);
                                }

                            if (docxTblRows.length > 0) {
                                docxDescs[track].value = docxDescs[track].value.replace('#:', '').replace(attrArr[cycl], allRefs.totalGroups[tGroupName]);

                                var c1 = docxTblRow('№', 325),
                                    c2 = docxTblRow('Наименование клиента', 3150),
                                    c3 = docxTblRow('Номер контракта', 1823),
                                    c4 = docxTblRow('Дата Контракта', 1227),
                                    c5 = docxTblRow('Сумма Контракта, руб', 1796),
                                    c6 = docxTblRow('Сумма Платежа, руб', 1796);
                                docxTblRows[0] = new XElement(W.tr, c1, c2, c3, c4, c5, c6);

                                var fc1 = docxTblRow('', 325),
                                    fc2 = docxTblRow('', 3150),
                                    fc3 = docxTblRow('', 1823),
                                    fc4 = docxTblRow('', 1227),
                                    fc5 = docxTblRow('ИТОГО:', 1796),
                                    fc6 = docxTblRow(kendo.toString(_setOrDefault(GetParseNum(currTblTotalSum)), 'n2'), 1796);
                                docxTblRows[docxTblRows.length] = new XElement(W.tr, fc1, fc2, fc3, fc4, fc5, fc6);

                                docxDescs[track].parent.parent.addAfterSelf(new XElement(W.tbl, tblPr, tblGrid, docxTblRows)); // Enumerable.from(docxTblRows)

                                updtdFlag = true;
                            }
                        }
                    }

                if (!updtdFlag) docxDescs[track].value = '????';
            }

            saveAs(doc.saveToBlob(), allRefs.docxTmpl);
        }

        function docxTblRow(cellCont, cellWidth) {
            var W = openXml.W;
            var XElement = Ltxml.XElement;
            var XAttribute = Ltxml.XAttribute;

            return new XElement(W.tc,
                        new XElement(W.tcPr,
                            new XElement(W.tcW, new XAttribute(W._w, cellWidth), new XAttribute(W.type, "dxa")),
                            new XElement(W.tcBorders,
                                new XElement(W.top, new XAttribute(W.val, 'single'), new XAttribute(W.space, 0), new XAttribute(W.color, 'auto'), new XAttribute(W.sz, 8)),
                                new XElement(W.left, new XAttribute(W.val, 'single'), new XAttribute(W.space, 0), new XAttribute(W.color, 'auto'), new XAttribute(W.sz, 8)),
                                new XElement(W.bottom, new XAttribute(W.val, 'single'), new XAttribute(W.space, 0), new XAttribute(W.color, 'auto'), new XAttribute(W.sz, 8)),
                                new XElement(W.right, new XAttribute(W.val, 'single'), new XAttribute(W.space, 0), new XAttribute(W.color, 'auto'), new XAttribute(W.sz, 8)))),
                        new XElement(W.p,
                            new XElement(W.pPr,
                                new XElement(W.spacing, new XAttribute(W.before, 10), new XAttribute(W.after, 10)),
                                new XElement(W.rPr,
                                    new XElement(W.rFonts, new XAttribute(W.ascii, "Times New Roman"), new XAttribute(W.hAnsi, "Times New Roman")))),
                            new XElement(W.r,
                                new XElement(W.rPr,
                                    new XElement(W.rFonts, new XAttribute(W.ascii, "Times New Roman"), new XAttribute(W.hAnsi, "Times New Roman"))),
                                new XElement(W.t, cellCont))));
        }

        function getAddApp(e) {
            var listView = $("#appsView").data("kendoListView");

            listView.add();
            e.preventDefault();
        }

        function gloDateChange() {
            /// <summary> Смена даты - фильтрация по дате создания
            /// </summary>
            var updDate = this.value();
            var treeView = $('#treeview').data('kendoTreeView');

            var treeViewItems = treeView.items();

            if (treeViewItems) {
                for (var step = 0, sLngth = treeViewItems.length; step < sLngth; step++)
                    if (treeView.dataItem(treeViewItems[step]) && treeView.dataItem(treeViewItems[step]).hasChildren) {
                        treeView.dataItem(treeViewItems[step]).children.filter((updDate) ? {
                            field: 'urb_date',
                            operator: 'gte',
                            value: updDate
                        } : null);

                        var phCount = 0,
                            leCount = 0;

                        if (updDate) {
                            var chldView = treeView.dataItem(treeViewItems[step]).children.view();
                            for (var loop = 0, lLngth = chldView.length; loop < lLngth; loop++)
                                if (chldView[loop].urb_leadId && chldView[loop].urb_leadId.Id !== chldView[loop].urb_Id) {
                                    phCount++;
                                    leCount++;
                                }
                                else if (chldView[loop].urb_leadId && chldView[loop].urb_leadId.Id == chldView[loop].urb_Id)
                                    leCount++;
                                else
                                    phCount++;
                        }

                        treeViewItems[step].innerHTML = treeViewItems[step].innerHTML.replace(treeView.dataItem(treeViewItems[step]).FullName,
                            treeView.dataItem(treeViewItems[step]).urb_name + ' ( ' + ((updDate) ? phCount : treeView.dataItem(treeViewItems[step]).urb_calls_total) + ' - ' + ((updDate) ? leCount : treeView.dataItem(treeViewItems[step]).urb_leads_total) + ' )');
                        treeView.dataItem(treeViewItems[step]).FullName = treeView.dataItem(treeViewItems[step]).urb_name + ' ( ' + phCount + ' - ' + leCount + ' )';
                    }
            }

        }

        function ComboBoxInit(widgetName, dataText, dataValue, dataSrc, filterType, isSuggest, indxNum) {
            $('#' + widgetName).kendoComboBox({
                dataTextField: dataText,
                dataValueField: dataValue,
                dataSource: dataSrc,
                filter: filterType,
                suggest: isSuggest,
                index: indxNum
            });
        }

        function AutoCompleteInit(widgetName, nameFld, filterVal, placeHold, minLngth, entityName) {
            $('#' + widgetName).kendoAutoComplete({
                dataTextField: nameFld,
                filter: filterVal,
                change: AutoCompleteOnChange,
                placeholder: placeHold,
                minLength: minLngth,
                dataSource: AutoCompleteDataSource(entityName, nameFld), // SmplsRetrieve(entityName, nameFld),
                suggest: true,
                separator: ", "
            }).data("kendoAutoComplete");
        }

        function GetAutoCompleteValue(widgetKey, values, options, fieldName) {
            /// <summary> Процедура сохранения объектного значения, выбранного в поле с автоподбором
            /// </summary>
            var retItems = [];
            var allData = options.dataSource.data();

            if (autoCompData[widgetKey] == null) autoCompData[widgetKey] = [];
            if (fieldName == null) fieldName = options.dataTextField;

            var saveData = autoCompData[widgetKey];

            for (var loop = 0, lpLength = values.length; loop < lpLength; loop++)
                for (var took = 0, tkLength = saveData.length; took < tkLength; took++)
                    if (values[loop].toLowerCase() === saveData[took][options.dataTextField].toLowerCase() &&
                        retItems.indexOf(saveData[took][fieldName]) < 0) {
                        retItems[retItems.length] = saveData[took][fieldName];
                        break;
                    }

            for (var loop = 0, lpLength = values.length; loop < lpLength; loop++)
                for (var step = 0, stLngth = allData.length; step < stLngth; step++)
                    if (values[loop].toLowerCase() === allData[step][options.dataTextField].toLowerCase() &&
                        retItems.indexOf(allData[step][fieldName]) < 0) {
                        autoCompData[widgetKey][autoCompData[widgetKey].length] = allData[step];
                        retItems[retItems.length] = allData[step][fieldName];
                        break;
                    }
            return retItems;
        }

        function AutoCompleteOnChange() {
            /// <summary> Событие изменения значения, выбранного в поле с автоподбором
            /// </summary>
            var vals = this.value().split(this.options.separator);

            if (vals.length === 0) return;

            var approveItems = GetAutoCompleteValue(this._optionID.replace('_option_selected', ''), vals, this.options);

            if (approveItems.length > 0 && vals[vals.length - 1] === '' && approveItems[approveItems.length - 1] != '')
                approveItems[approveItems.length] = ' ';

            if (approveItems.length != vals.length)
                this.value(approveItems.join(this.options.separator));
        }

        function AutoCompleteDataSource(entName, nameFld) {
            /// <summary> Серверный источник данных для полей с подбором:
            /// подбор значений происходит с сервера в момент подбора</summary>
            return new kendo.data.DataSource({
                serverFiltering: true,
                transport: {
                    read: {
                        url: _getServerUrl() + '/XRMServices/2011/OrganizationData.svc/' + entName + 'Set',
                        dataType: 'json'
                    },
                    parameterMap: function (options) {

                        var filterString = (options.filter != null && options.filter.filters != null && options.filter.filters.length == 0) ? _snglFltr_NotNull(nameFld) :
                            (options.filter.filters[0].operator == "contains") ? _snglFltr_Substringof(options.filter.filters[0].field, options.filter.filters[0].value) :
                            (options.filter.filters[0].operator == "startswith") ? _snglFltr_BeginsWith(options.filter.filters[0].field, options.filter.filters[0].value) :
                            _snglFltr_StringEquals(options.filter.filters[0].field, options.filter.filters[0].value);

                        return {
                            $select: entName + 'Id,' + nameFld,
                            $filter: filterString
                        };
                    }
                },
                schema: {
                    parse: function (data) {
                        return data.d.results;
                    }
                }
            });
        }

        function snglUpdateFld(controlUpd) {
            var updateBlock = _getElemById(controlUpd.id + '_block');

            if (updateBlock) {
                _updateVisibl(controlUpd.id, false);
                _updateVisibl(controlUpd.id + '_block', true);

                var updateControl = _getElemById(controlUpd.id + '_ent');
                updateControl.value = _getCheckVal(controlUpd.id, controlUpd.innerText);

                if (controlUpd.id in allRefs.optsAttr)
                    $('#' + controlUpd.id + '_ent').data('kendoComboBox').value(updateControl.value);

                _updateVisibl('save_client', true);
            }
        }

        function SmplsRetrieve(entName, mainFld, retrFltr) {
            /// <summary> Выполнение простого запроса данных сущности,
            /// заданной именем entName</summary>
            var regionData = _syncAjax(_getServerUrl(), entName, entName + 'Id,' + mainFld, (retrFltr) ? retrFltr : _snglFltr_NotNull(mainFld));

            return regionData.d.results;
        }

        function addNewClient() {
            /// <summary> Добавление нового клиента
            /// </summary>
            var trview = $('#treeview').data('kendoTreeView');

            var rootDataItem = trview.dataSource.data()[0];

            trview.expand(trview.findByUid(rootDataItem.uid));

            var chldrnItems = (rootDataItem.children) ? rootDataItem.children.data() : null;

            var newClient = {};

            if (chldrnItems && chldrnItems.length > 0)
                for (var step = 0, sLngth = chldrnItems.length; step < sLngth; step++)
                    if (chldrnItems[step].urb_Id == '') {
                        newClient = chldrnItems[step];
                        break;
                    }

            if (newClient.uid == null || newClient.uid == undefined) {
                for (var prop in leadClientModel)
                    newClient[prop] = (~prop.indexOf('urb_date')) ? new Date() :
                        (~prop.indexOf('imageUrl')) ? "../WebResources/urb_customer.png" : (~prop.indexOf('hasChildren')) ? false :
                        (~prop.indexOf('urb_leadId')) ? {} : (~prop.indexOf('Nodename')) ? '<новый клиент>' : '';

                rootDataItem.Clients.unshift(newClient);

                if (newClient.uid == null || newClient.uid == undefined)
                    newClient.uid = chldrnItems[0].uid;
            }

            UpdateTreeViewSelect(newClient.uid, 0);

            ViewCardForm(newClient, true);
        }

        function RenewQuarter(periodQuart, checkMans, ignorAttrib, quartPlans, managsPoss, saleRate) { // квартал как единый период - вместо массива periodsArray
            //if (!_isArrayFill(periodsArray)) return;

            reportData = [];

            if (ignorAttrib) reportTotals = {};

            //for (var step = 0, sLngth = periodsArray.length; step < sLngth; step++) {
            var cntrctsSet = allRefs._actcontrdata.concat(allRefs._cancontrdata); //contracts(periodsArray[step]);

            for (var loop = 0, lLngth = cntrctsSet.length; loop < lLngth; loop++) {
                var stepRec = AddRepLineQuart(periodQuart, cntrctsSet[loop]);

                if (stepRec == null || (ignorAttrib && (ignorAttrib in stepRec) && _setOrDefault(stepRec[ignorAttrib], 0) == 0)) continue;

                if (checkMans && stepRec.halfManager != null) {
                    var halfManRec = AddRepLineQuart(periodQuart, cntrctsSet[loop]);

                    halfManRec.Manager = stepRec.halfManager;
                    halfManRec.ManagerName = getViewName(halfManRec.Manager);
                    halfManRec.halfManager = stepRec.Manager;
                    halfManRec.halfManagerName = getViewName(halfManRec.halfManager);

                    halfManRec.agreeAmount = _setMoneyValue(GetParseNum(halfManRec.agreeAmount) / 2);
                    halfManRec.saleAmount = _setMoneyValue(GetParseNum(halfManRec.saleAmount) / 2);
                    halfManRec.payAmount = _setMoneyValue(GetParseNum(halfManRec.payAmount) / 2);
                    halfManRec.areaSquare = GetParseNum(halfManRec.areaSquare) / 2;
                    halfManRec.calculAmount = _setMoneyValue(GetParseNum(halfManRec.calculAmount) / 2);

                    stepRec.agreeAmount = GetParseNum(stepRec.agreeAmount) - halfManRec.agreeAmount;
                    stepRec.saleAmount = GetParseNum(stepRec.saleAmount) - halfManRec.saleAmount;
                    stepRec.payAmount = GetParseNum(stepRec.payAmount) - halfManRec.payAmount;
                    stepRec.areaSquare = GetParseNum(stepRec.areaSquare) - halfManRec.areaSquare;
                    stepRec.calculAmount = GetParseNum(stepRec.calculAmount) - halfManRec.calculAmount;
                    stepRec.baseRecord = true; // флаг идентификации записи основного менеджера

                    reportData[reportData.length] = halfManRec;

                    if (ignorAttrib && _setOrDefault(halfManRec.areaSquare, 0) != 0) // - итоги halfManRec
                        addObjManTotal(halfManRec.buildObject, halfManRec.Manager, halfManRec.calculAmount, halfManRec.areaSquare);
                }

                reportData[reportData.length] = stepRec;

                if (ignorAttrib && _setOrDefault(stepRec.areaSquare, 0) != 0) // -итоги stepRec
                    addObjManTotal(stepRec.buildObject, stepRec.Manager, stepRec.calculAmount, stepRec.areaSquare);
            }
            //}
            var bgnDate = new Date(periodQuart.startDate.getFullYear(), periodQuart.startDate.getMonth(), periodQuart.startDate.getDate(), 23, 59, 59);

            reportData = reportData.filter(
                function (value) {
                    return (value.calculAmount > 0 || (value.calculAmount < 0 && value.orderDate <= bgnDate));
                }
                );

            for (var oprop in reportTotals) {// итоги --
                var objTotal = 0;

                for (var stom = 0, stLngth = reportData.length; stom < stLngth; stom++)
                    if (reportData[stom].buildObject == oprop)
                        objTotal += reportData[stom].calculAmount;

                var perCent = objTotal * 100 / quartPlans[oprop];

                for (var zoox = 0, zLngth = reportData.length; zoox < zLngth; zoox++)
                    if (_setOrDefault(reportData[zoox].areaSquare, 0) > 0 && reportData[zoox].buildObject == oprop) {

                        reportData[zoox]['manPerc'] = _setOrDefault(perCent);
                        reportData[zoox]['objPlan'] = _setOrDefault(quartPlans[oprop]);

                        var realPosition = '';

                        if (reportData[zoox]['Manager'] in managsPoss && reportData[zoox]['buildObject'] in managsPoss[reportData[zoox]['Manager']])
                            realPosition = managsPoss[reportData[zoox]['Manager']][reportData[zoox]['buildObject']];

                        for (var iter = 0, iLngth = saleRate.length; iter < iLngth; iter++)
                            if (_setOrDefault(saleRate[iter][ratingModel.urb_role]) == realPosition) {
                                var prcFrom = (_setOrDefault(saleRate[iter][ratingModel.urb_perc_from]) != '') ? GetParseNum(saleRate[iter][ratingModel.urb_perc_from]) : 0;
                                var prcUpto = (_setOrDefault(saleRate[iter][ratingModel.urb_perc_to]) != '') ? GetParseNum(saleRate[iter][ratingModel.urb_perc_to]) : 100000;

                                if (perCent >= prcFrom && perCent < prcUpto) {
                                    reportData[zoox]['manRate'] = GetParseNum(saleRate[iter][ratingModel.urb_rate_quart]);
                                    break;
                                }
                            }

                        if (_setOrDefault(reportData[zoox]['act1Date']) != '' && 'manRate' in reportData[zoox] && GetParseNum(reportData[zoox]['manRate']) > 0 &&
                            'calculAmount' in reportData[zoox] && GetParseNum(reportData[zoox]['calculAmount']) > 0) {
                            reportData[zoox]['bonusAmount'] = GetParseNum(reportData[zoox]['calculAmount']) / 100 * GetParseNum(reportData[zoox]['manRate']);
                        }
                    }
            }

            _updateVisibl('reportGrid', true);

            var repGrid = $('#reportGrid').data('kendoGrid');
            repGrid.dataSource.data(reportData);

            var columnsVision = { act1Date: true, manRate: true, manPerc: true, objPlan: true, bonusAmount: true };

            if (_isArrayFill(repGrid.columns))
                for (var colx = 0, cLngth = repGrid.columns.length; colx < cLngth; colx++)
                    if (repGrid.columns[colx].field in columnsVision) {
                        if (columnsVision[repGrid.columns[colx].field]) repGrid.showColumn(colx);
                        else repGrid.hideColumn(colx);
                    }

            repGrid.setDataSource(repGrid.dataSource);
        }

        function RenewReportData(periodsArray, checkMans, ignorAttrib) { // квартал как аргумент = три месяца в массиве
            if (!_isArrayFill(periodsArray)) return;

            reportData = [];

            if (ignorAttrib) reportTotals = {};
            
            for (var step = 0, sLngth = periodsArray.length; step < sLngth; step++) {
                var cntrctsSet = allRefs.contracts(periodsArray[step]);

                for (var loop = 0, lLngth = cntrctsSet.length; loop < lLngth; loop++) {
                    var stepRec = AddRepLine(periodsArray[step], cntrctsSet[loop]);

                    if (stepRec == null || (ignorAttrib && (ignorAttrib in stepRec) && _setOrDefault(stepRec[ignorAttrib], 0) == 0)) continue;

                    if (checkMans && stepRec.halfManager != null) {
                        var halfManRec = AddRepLine(periodsArray[step], cntrctsSet[loop]);

                        halfManRec.Manager = stepRec.halfManager;
                        halfManRec.ManagerName = getViewName(halfManRec.Manager);
                        halfManRec.halfManager = stepRec.Manager;
                        halfManRec.halfManagerName = getViewName(halfManRec.halfManager);

                        halfManRec.agreeAmount = _setMoneyValue(GetParseNum(halfManRec.agreeAmount) / 2);
                        halfManRec.saleAmount = _setMoneyValue(GetParseNum(halfManRec.saleAmount) / 2);
                        halfManRec.payAmount = _setMoneyValue(GetParseNum(halfManRec.payAmount) / 2);
                        halfManRec.areaSquare = GetParseNum(halfManRec.areaSquare) / 2;
                        halfManRec.calculAmount = _setMoneyValue(GetParseNum(halfManRec.calculAmount) / 2);

                        stepRec.agreeAmount = GetParseNum(stepRec.agreeAmount) - halfManRec.agreeAmount;
                        stepRec.saleAmount = GetParseNum(stepRec.saleAmount) - halfManRec.saleAmount;
                        stepRec.payAmount = GetParseNum(stepRec.payAmount) - halfManRec.payAmount;
                        stepRec.areaSquare = GetParseNum(stepRec.areaSquare) - halfManRec.areaSquare;
                        stepRec.calculAmount = GetParseNum(stepRec.calculAmount) - halfManRec.calculAmount;
                        stepRec.baseRecord = true; // флаг идентификации записи основного менеджера

                        reportData[reportData.length] = halfManRec;

                        if (ignorAttrib && _setOrDefault(halfManRec.areaSquare, 0) != 0) // - итоги halfManRec
                            addObjManTotal(halfManRec.buildObject, halfManRec.Manager, halfManRec.calculAmount, halfManRec.areaSquare);
                    }

                    reportData[reportData.length] = stepRec;

                    if (ignorAttrib && _setOrDefault(stepRec.areaSquare, 0) != 0) // -итоги stepRec
                        addObjManTotal(stepRec.buildObject, stepRec.Manager, stepRec.calculAmount, stepRec.areaSquare);
                }
            }
        }

        function addObjManTotal(buildObject, Manager, calculAmount, areaSquare) {
            if (!(buildObject in reportTotals) || !(Manager in reportTotals[buildObject])) {

                if (!(buildObject in reportTotals)) reportTotals[buildObject] = {};

                reportTotals[buildObject][Manager] = { Value: calculAmount, Square: areaSquare };
            }
            else {
                reportTotals[buildObject][Manager].Value += calculAmount;
                reportTotals[buildObject][Manager].Square += areaSquare;
            }
        }

        function ParseYear(yearNum) {
            /// <summary> Раскладка года на периоды
            /// </summary>
            var nowDate = new Date();
            nowDate.setDate(nowDate.getDate() + 6);

            var retArray = [],
                prdsArray = [],
                mnthArray = _objectUrbArray(allRefs.monthes);

            for (var step = 0, sLngth = mnthArray.length; step < sLngth; step++) {

                if (yearNum == nowDate.getFullYear() && step == nowDate.getMonth()) {
                    prdsArray[0] = allRefs.PeriodObject(yearNum, step + 1);
                    prdsArray[1] = allRefs.PeriodObject(yearNum - (step == 0 ? 1 : 0), (step == 0) ? 12 : step);
                    
                    RenewReportData(prdsArray, false);
                } // ---

                if (yearNum == nowDate.getFullYear() && step > nowDate.getMonth())
                    break;

                retArray[retArray.length] = allRefs.MonthNode(yearNum, mnthArray[step].value, mnthArray[step].text);

                if ((step + 1) % 3 == 0) {
                    var quartValue = (step + 1) / 3;

                    retArray[retArray.length] = allRefs.QuartNode(yearNum, quartValue, quartValue + ' квартал');
                        
                }
            }

            return retArray;
        }

        function onTreeSelect(e) {
            /// <summary> Событие выбора ветви дерева - Точка входа
            /// </summary>
            if (this.dataItem(e.node) == null) return;

            var nodeData = this.dataItem(e.node);

            if (nodeData.hasChildren) return;

            var fixButton = $('#fix_rates').data('kendoButton');
            fixButton.enable(false);

            var searchAutocomp = $('#search_word').data('kendoAutoComplete');
            searchAutocomp.value(null);

            var currNodeName = _setOrDefault(nodeData.Nodename, allRefs.nodeValues[0]);
            var currPeriod = allRefs.PeriodObject(nodeData.year, nodeData.month);

            ToggleListCard(currNodeName == allRefs.nodeValues[0] || currNodeName == allRefs.nodeValues[2]);

            if (currNodeName == allRefs.nodeValues[0]) { // План продаж ----------------------
                var planData = [];
                // allConns - соединения менеджеров с объектами с указанием роли менеджера: продавец или старший менеджер (либо что-то ещё, если будет добавлено)
                var allConns = allRefs.prjects();
                // mnthPlans - плановые показатели выбранного периода, сохраненные в системе
                var mnthPlans = allRefs.plannings(nodeData.year, allRefs.defaults.periods, nodeData.month);

                mnthPlans = mnthPlans.sort(
                    function (a, b) {
                        var recAVal = getViewName(a[planningModel.urb_manager].Name),
                            recBVal = getViewName(b[planningModel.urb_manager].Name);

                        return (recAVal > recBVal) ? -1 : (recBVal > recAVal) ? 1 : 0;
                    });

                if (_isArrayFill(mnthPlans)) // дополнение массива ролевых связей объекта и менеджера, если менеджер в плане задан, а связь с объектом его не была определена
                    for (var took = 0, tLngth = mnthPlans.length; took < tLngth; took++)
                        if (planningModel.urb_manager in mnthPlans[took] && mnthPlans[took][planningModel.urb_manager].Id != null) {
                            var isFinded = false;

                            for (var hook = 0, hLngth = allConns.length; hook < hLngth; hook++)
                                if (mnthPlans[took][planningModel.urb_manager].Id == allConns[hook][connectModel.urb_link_to].Id &&
                                    mnthPlans[took][planningModel.urb_objProject].Id == allConns[hook][connectModel.urb_link_from].Id) {
                                    isFinded = true;
                                    break;
                                }

                            if (!isFinded) {
                                var newConn = {};
                                newConn[connectModel.urb_link_from] = mnthPlans[took][planningModel.urb_objProject];
                                newConn[connectModel.urb_link_to] = mnthPlans[took][planningModel.urb_manager];
                                newConn[connectModel.urb_role_to] = {
                                    Id: 'dcd77cc8-db91-e511-892c-00155d0a3302',
                                    Name: mnthPlans[took][planningModel.urb_man_role],
                                    LogicalName: 'role'
                                };

                                allConns.push(newConn);
                            }
                        }

                allConns = allConns.sort(
                    function (a, b) {
                        var recAVal = a[connectModel.urb_link_from].Name.toLowerCase() + a[connectModel.urb_role_to].Name.toLowerCase(),
                            recBVal = b[connectModel.urb_link_from].Name.toLowerCase() + b[connectModel.urb_role_to].Name.toLowerCase();

                        return (recAVal < recBVal) ? -1 : (recBVal < recAVal) ? 1 : 0;
                    });
                // stepObj - объект; stepTotals - итоги по объекту
                var stepObj = '',
                    stepTotals = { planValue: 0, planSquare: 0, objValue: 0, objSquare: 0 };
                // обход записей сопоставления менеджера с объектом отсортированные по имени объекта; проход идет по всем менеджерам одного объекта подряд
                for (var step = 0, sLngth = allConns.length; step < sLngth; step++) {
                    if (stepObj == '' || stepObj.Name != allConns[step][connectModel.urb_link_from].Name) {
                        // очередной объект (на предыдущем шаге было либо начало цикла, либо ещё другой объект)
                        stepObj = allConns[step][connectModel.urb_link_from]; // { Id, Name }

                        var addObj = allRefs.PlanRecord(mnthPlans, stepObj);

                        for (var prop in stepTotals)
                            stepTotals[prop] = (prop == 'objValue') ? addObj.planValue * 10 / 9 : (prop == 'objSquare') ? addObj.planSquare * 10 / 9 : 0;

                        planData.push(addObj);
                    }

                    var addMan = allRefs.PlanRecord(mnthPlans, stepObj, allConns[step]);

                    for (var prop in stepTotals)

                        if (prop in addMan) stepTotals[prop] += GetParseNum(addMan[prop]);
                    
                    planData.push(addMan);

                    if (step == (sLngth - 1) || stepObj.Name != allConns[step + 1][connectModel.urb_link_from].Name)
                        planData.push(allRefs.PlanRecord(stepTotals, stepObj));
                }

                SetClientList(new kendo.data.DataSource({
                    schema: {
                        data: function (data) { return planData; }
                    }
                }), 'planListTmpl');
            }
            else if (currNodeName == allRefs.nodeValues[1]) { // Начисления -------------
                fixButton.enable(true);
                RenewReportData([currPeriod], true, 'payAmount');

                var saleRate = allRefs.ratings();
                var mnthPlans = allRefs.plannings(nodeData.year, allRefs.defaults.periods, nodeData.month);
                // Данные показателей сгруппированные по роли -->
                var ratesSet = {};

                var dfltRole = '_DFLT_Manager',
                    rolAttr = ratingModel.urb_role;

                for (var y_lop = 0, yLngth = saleRate.length; y_lop < yLngth; y_lop++) {
                    if (!(ratingModel.urb_rate_mnth in saleRate[y_lop]) || _setOrDefault(saleRate[y_lop][ratingModel.urb_rate_mnth]) == '') continue;

                    var stepRole = (saleRate[y_lop][rolAttr] != null && saleRate[y_lop][rolAttr] != '') ? saleRate[y_lop][rolAttr] : dfltRole;

                    if (!(stepRole in ratesSet)) ratesSet[stepRole] = [];

                    ratesSet[stepRole][ratesSet[stepRole].length] = {
                        Rate: GetParseNum(saleRate[y_lop][ratingModel.urb_rate_mnth]),
                        From: (_setOrDefault(saleRate[y_lop][ratingModel.urb_perc_from]) != '') ? GetParseNum(saleRate[y_lop][ratingModel.urb_perc_from]) : -100000,
                        To: (_setOrDefault(saleRate[y_lop][ratingModel.urb_perc_to]) != '') ? GetParseNum(saleRate[y_lop][ratingModel.urb_perc_to]) : 100000
                    };
                } // <-- Данные показателей сгруппированные по роли
                // Данные планов сгруппированные по объекту и менеджеру -->
                var planSet = {};

                var orateAttr = 'objRateFactor',
                    manAttr = planningModel.urb_manager,
                    objAttr = planningModel.urb_objProject;
                
                for (var x_lop = 0, xLngth = mnthPlans.length; x_lop < xLngth; x_lop++) {
                    if (!(objAttr in mnthPlans[x_lop]) || mnthPlans[x_lop][objAttr].Name == null) continue;

                    if (!(mnthPlans[x_lop][objAttr].Name in planSet)) planSet[mnthPlans[x_lop][objAttr].Name] = {};

                    if (!(manAttr in mnthPlans[x_lop]) || mnthPlans[x_lop][manAttr].Name == null) {
                        
                        if (planningModel.urb_rsn_factor in mnthPlans[x_lop] && mnthPlans[x_lop][planningModel.urb_rsn_factor] != null && mnthPlans[x_lop][objAttr].Name in reportTotals)
                            reportTotals[mnthPlans[x_lop][objAttr].Name][orateAttr] = GetParseNum(mnthPlans[x_lop][planningModel.urb_rsn_factor]);
                        
                        continue;
                    }

                    if (!(mnthPlans[x_lop][manAttr].Name in planSet[mnthPlans[x_lop][objAttr].Name])) planSet[mnthPlans[x_lop][objAttr].Name][mnthPlans[x_lop][manAttr].Name] = {
                        planValue: mnthPlans[x_lop][planningModel.urb_plan_amount],
                        realPositn: mnthPlans[x_lop][planningModel.urb_man_role]
                    };
                } // <-- Данные планов сгруппированные по объекту и менеджеру

                for (var oprop in reportTotals) { // итоги --
                    for (var orpt = 0, oLngth = mnthPlans.length; orpt < oLngth; orpt++)
                        if (planningModel.urb_manager in mnthPlans[orpt] && mnthPlans[orpt][planningModel.urb_manager].Id == null &&
                                planningModel.urb_objProject in mnthPlans[orpt] && _setOrDefault(mnthPlans[orpt][planningModel.urb_objProject].Name) == oprop &&
                                planningModel.urb_rsn_factor in mnthPlans[orpt] && GetParseNum(mnthPlans[orpt][planningModel.urb_rsn_factor]) > 0) {
                            reportTotals[oprop]['objRateFactor'] = GetParseNum(mnthPlans[orpt][planningModel.urb_rsn_factor]);
                            break;
                        }

                    for (var mprop in reportTotals[oprop]) {
                        if (mprop == orateAttr) continue;

                        var realPosition = '';
                        var realPerc = 77,
                            planValue = null;
                        // здесь нужно переделать, так как не учитывается простая связь менеджера в определенной роли с объектом
                        for (var loop = 0, lLngth = mnthPlans.length; loop < lLngth; loop++)
                            if (planningModel.urb_manager in mnthPlans[loop] && _setOrDefault(mnthPlans[loop][planningModel.urb_manager].Name) == mprop &&
                                planningModel.urb_objProject in mnthPlans[loop] && _setOrDefault(mnthPlans[loop][planningModel.urb_objProject].Name) == oprop) {
                                // Value, Square, PlanValue, Percent, Rate
                                var totalValue = reportTotals[oprop][mprop].Value;
                                planValue = GetParseNum(mnthPlans[loop][planningModel.urb_plan_amount]);
                                realPosition = mnthPlans[loop][planningModel.urb_man_role];

                                if (planValue != null && planValue > 0)
                                    realPerc = Math.round(GetParseNum(totalValue) * 100 / planValue);
                            }

                        reportTotals[oprop][mprop].Percent = realPerc;
                        reportTotals[oprop][mprop].PlanValue = planValue;

                        if (realPosition != '') {
                            var tmpArr = saleRate.filter(
                                function (value) {
                                    return (_setOrDefault(value[ratingModel.urb_rate_mnth]) != '' && value[ratingModel.urb_role] == realPosition);
                                }
                            );

                            if (tmpArr.length == 0) realPosition = '';
                        }

                        for (var iter = 0, iLngth = saleRate.length; iter < iLngth; iter++)
                            if (_setOrDefault(saleRate[iter][ratingModel.urb_rate_mnth]) != '' &&
                                _setOrDefault(saleRate[iter][ratingModel.urb_role]) == realPosition) {
                                var prcFrom = (_setOrDefault(saleRate[iter][ratingModel.urb_perc_from]) != '') ? GetParseNum(saleRate[iter][ratingModel.urb_perc_from]) : 0;
                                var prcUpto = (_setOrDefault(saleRate[iter][ratingModel.urb_perc_to]) != '') ? GetParseNum(saleRate[iter][ratingModel.urb_perc_to]) : 100000;

                                if (realPerc >= prcFrom && realPerc < prcUpto) {
                                    reportTotals[oprop][mprop].Rate = GetParseNum(saleRate[iter][ratingModel.urb_rate_mnth]);
                                    break;
                                }
                            }
                    }
                }// -- итоги

                for (var zoox = 0, zLngth = reportData.length; zoox < zLngth; zoox++)
                    if (_setOrDefault(reportData[zoox].areaSquare, 0) > 0 && reportData[zoox].buildObject in reportTotals &&
                        reportData[zoox].Manager in reportTotals[reportData[zoox].buildObject]) {

                        reportData[zoox]['manRate'] = _setOrDefault(reportTotals[reportData[zoox].buildObject][reportData[zoox].Manager].Rate);
                        reportData[zoox]['manPerc'] = _setOrDefault(reportTotals[reportData[zoox].buildObject][reportData[zoox].Manager].Percent);
                        reportData[zoox]['objPlan'] = _setOrDefault(reportTotals[reportData[zoox].buildObject][reportData[zoox].Manager].PlanValue);
                        reportData[zoox]['objRate'] = _setOrDefault(reportTotals[reportData[zoox].buildObject].objRateFactor, 1);
                        // на данном этапе добавляем внесенный для объекта коэффициент к вычисленному коэффициенту каждого менеджера в проекте
                        if (reportData[zoox]['objRate'] > 1)
                            reportData[zoox]['manRate'] = reportData[zoox]['manRate'] * reportData[zoox]['objRate'];
                    }
                        

                var repGrid = $('#reportGrid').data('kendoGrid');
                repGrid.dataSource.data(reportData);

                var columnsVision = { manRate: true, manPerc: true, objPlan: true, objRate: true, bonusAmount: false };

                if (_isArrayFill(repGrid.columns))
                    for (var colx = 0, cLngth = repGrid.columns.length; colx < cLngth; colx++)
                        if (repGrid.columns[colx].field in columnsVision) {
                            if (columnsVision[repGrid.columns[colx].field]) repGrid.showColumn(colx);
                            else repGrid.hideColumn(colx);
                        }
                
                repGrid.setDataSource(repGrid.dataSource);
            }
            else if (currNodeName == allRefs.nodeValues[2]) { // Актирование -----------------
                var contrRecs = [],
                    contrArray = allRefs.contracts(currPeriod);

                for (var took = 0, tLngth = contrArray.length; took < tLngth; took++)
                    contrRecs.push(allRefs.getContractObj(currPeriod, contrArray[took]));

                SetClientList(new kendo.data.DataSource({
                    schema: {
                        data: function (data) { return contrRecs; }
                    }
                }), 'clientListTmpl');
            }
            else if (currNodeName == allRefs.nodeValues[3]) { // К оплате ---------------------------------------------------------------
                var periodsArr = [];
                periodsArr.push(currPeriod);
                // нужно изменить подход: договоры к оплате нужно отбирать по дате актирования
                for (var take = 1; take < 11; take++) { // получение всех договоров за несколько месяцев для отбора актированных - неправильно, так как будет лихо тормозить. Нужно оптимизировать
                    var takeMnth = currPeriod.monthValue - take + ((currPeriod.monthValue > take) ? 0 : 12);
                    var takeYear = currPeriod.yearValue - ((currPeriod.monthValue > take) ? 0 : 1);

                    if (takeYear < 2016) continue;

                    periodsArr.push(allRefs.PeriodObject(takeYear, takeMnth));
                }

                RenewReportData(periodsArr, true, 'act1Date');

                var fltrDate = new Date(currPeriod.finishDate.getFullYear(), currPeriod.finishDate.getMonth(), currPeriod.finishDate.getDate(), 23, 59, 59),
                    bgnDate = new Date(currPeriod.startDate.getFullYear(), currPeriod.startDate.getMonth(), currPeriod.startDate.getDate(), 23, 59, 59);

                reportData = reportData.filter(
                    function (value) {
                        return (value.act1Date > bgnDate && value.act1Date <= fltrDate);
                    }
                    );

                for (var zoox = 0, zLngth = reportData.length; zoox < zLngth; zoox++)
                    if (_setOrDefault(reportData[zoox].areaSquare, 0) > 0 && _setOrDefault(reportData[zoox].calculAmount, 0) > 0) {

                        reportData[zoox]['manRate'] = (reportData[zoox].halfManager && typeof reportData[zoox].baseRecord == 'undefined') ? reportData[zoox].halfManagerRate : reportData[zoox].ManagerRate;
                        reportData[zoox]['manPerc'] = (reportData[zoox].halfManager && typeof reportData[zoox].baseRecord == 'undefined') ? reportData[zoox].halfManagerPerc : reportData[zoox].ManagerPerc;
                        reportData[zoox]['bonusAmount'] = reportData[zoox].calculAmount / 100 * GetParseNum(reportData[zoox]['manRate']);
                    }
                    else if (reportData[zoox].appType == 'Машиноместо') {
                        reportData[zoox]['bonusAmount'] = (GetParseNum(reportData[zoox].saleAmount) > 500000) ? 3000 : 1500;
                    }
                    else if (reportData[zoox].appType == 'Кладовая') {
                        reportData[zoox]['bonusAmount'] = 1500;
                    }

                var repGrid = $('#reportGrid').data('kendoGrid');
                repGrid.dataSource.data(reportData);

                var columnsVision = { manRate: true, manPerc: true, objPlan: false, bonusAmount: true };

                if (_isArrayFill(repGrid.columns))
                    for (var colx = 0, cLngth = repGrid.columns.length; colx < cLngth; colx++)
                        if (repGrid.columns[colx].field in columnsVision) {
                            if (columnsVision[repGrid.columns[colx].field]) repGrid.showColumn(colx);
                            else repGrid.hideColumn(colx);
                        }

                repGrid.setDataSource(repGrid.dataSource);
            }
            else if (currNodeName == allRefs.quartNode) { // Квартал - Итоги ---------------------------------------------------------------------------

                _updateVisibl('reportGrid', false);

                var periods = [],
                    quartPlans = {},
                    managsPoss = {};

                for (var ques = 0; ques < 3; ques++)
                    periods[periods.length] = allRefs.PeriodObject(nodeData.year, ((nodeData.quarter - 1) * 3) + ques + 1);

                var quartPeriod = allRefs.PeriodObject(nodeData.year, periods[0].monthValue);
                quartPeriod.finishDate = periods[periods.length - 1].finishDate;
                quartPeriod.periodName = (((periods[0].monthValue - 1) / 3) + 1).toString() + ' квартал ';

                allRefs.contractsAsync(quartPeriod); // асинхронный запрос - результат следует искать в renew-методе

                var saleRate = allRefs.ratings().filter(
                                function (value) {
                                    return (_setOrDefault(value[ratingModel.urb_rate_quart]) != '');
                                }
                            ); // urb_rate_quart

　
                for (var pers = 0, pLngth = periods.length; pers < pLngth; pers++) {
                    
                    var mnthPlans = allRefs.plannings(nodeData.year, allRefs.defaults.periods, periods[pers].monthValue);

                    for (var loop = 0, lLngth = mnthPlans.length; loop < lLngth; loop++)
                        if (planningModel.urb_manager in mnthPlans[loop] && mnthPlans[loop][planningModel.urb_manager].Id
                            && planningModel.urb_objProject in mnthPlans[loop]) {
                            if (!(mnthPlans[loop][planningModel.urb_manager].Name in managsPoss))
                                managsPoss[mnthPlans[loop][planningModel.urb_manager].Name] = {};

                            if (planningModel.urb_man_role in mnthPlans[loop] && mnthPlans[loop][planningModel.urb_man_role] != 'Специалист по продажам' &&
                                !(mnthPlans[loop][planningModel.urb_objProject].Name in managsPoss[mnthPlans[loop][planningModel.urb_manager].Name]))
                                managsPoss[mnthPlans[loop][planningModel.urb_manager].Name][mnthPlans[loop][planningModel.urb_objProject].Name] = mnthPlans[loop][planningModel.urb_man_role];

                            if (!(mnthPlans[loop][planningModel.urb_objProject].Name in quartPlans))
                                quartPlans[mnthPlans[loop][planningModel.urb_objProject].Name] = 0;

                            quartPlans[mnthPlans[loop][planningModel.urb_objProject].Name] += GetParseNum(mnthPlans[loop][planningModel.urb_plan_amount]);
                        }
                }

                var timerCount = 0;

                setTimeout(function goFor() {
                    timerCount++;

                    if (timerCount < 200 && (allRefs.contractsGoAct || allRefs.contractsGoCanc))
                        setTimeout(goFor, 100);
                    else
                        RenewQuarter(quartPeriod, true, 'payAmount', quartPlans, managsPoss, saleRate);
                }, 100);

                //RenewReportData(periods, true, 'payAmount');

                //var bgnDate = new Date(periods[0].startDate.getFullYear(), periods[0].startDate.getMonth(), periods[0].startDate.getDate(), 23, 59, 59);

                //reportData = reportData.filter(
                //    function (value) {
                //        return (value.calculAmount > 0 || (value.calculAmount < 0 && value.orderDate <= bgnDate));
                //    }
                //    );

                //for (var oprop in reportTotals) {// итоги --
                //    var objTotal = 0;

                //    for (var stom = 0, stLngth = reportData.length; stom < stLngth; stom++)
                //        if (reportData[stom].buildObject == oprop)
                //            objTotal += reportData[stom].calculAmount;
                    
                //    var perCent = objTotal * 100 / quartPlans[oprop];

                //    for (var zoox = 0, zLngth = reportData.length; zoox < zLngth; zoox++)
                //        if (_setOrDefault(reportData[zoox].areaSquare, 0) > 0 && reportData[zoox].buildObject == oprop) {

                //            reportData[zoox]['manPerc'] = _setOrDefault(perCent);
                //            reportData[zoox]['objPlan'] = _setOrDefault(quartPlans[oprop]);

                //            var realPosition = '';

                //            if (reportData[zoox]['Manager'] in managsPoss && reportData[zoox]['buildObject'] in managsPoss[reportData[zoox]['Manager']])
                //                realPosition = managsPoss[reportData[zoox]['Manager']][reportData[zoox]['buildObject']];

                //            for (var iter = 0, iLngth = saleRate.length; iter < iLngth; iter++)
                //                if (_setOrDefault(saleRate[iter][ratingModel.urb_role]) == realPosition) {
                //                    var prcFrom = (_setOrDefault(saleRate[iter][ratingModel.urb_perc_from]) != '') ? GetParseNum(saleRate[iter][ratingModel.urb_perc_from]) : 0;
                //                    var prcUpto = (_setOrDefault(saleRate[iter][ratingModel.urb_perc_to]) != '') ? GetParseNum(saleRate[iter][ratingModel.urb_perc_to]) : 100000;

                //                    if (perCent >= prcFrom && perCent < prcUpto) {
                //                        reportData[zoox]['manRate'] = GetParseNum(saleRate[iter][ratingModel.urb_rate_quart]);
                //                        break;
                //                    }
                //                }

                //            if (_setOrDefault(reportData[zoox]['act1Date']) != '' && 'manRate' in reportData[zoox] && GetParseNum(reportData[zoox]['manRate']) > 0 &&
                //                'calculAmount' in reportData[zoox] && GetParseNum(reportData[zoox]['calculAmount']) > 0) {
                //                reportData[zoox]['bonusAmount'] = GetParseNum(reportData[zoox]['calculAmount']) / 100 * GetParseNum(reportData[zoox]['manRate']);
                //            }
                //        }
                //}

                //var repGrid = $('#reportGrid').data('kendoGrid');
                //repGrid.dataSource.data(reportData);

                //var columnsVision = { act1Date: true, manRate: true, manPerc: true, objPlan: true, bonusAmount: true };

                //if (_isArrayFill(repGrid.columns))
                //    for (var colx = 0, cLngth = repGrid.columns.length; colx < cLngth; colx++)
                //        if (repGrid.columns[colx].field in columnsVision) {
                //            if (columnsVision[repGrid.columns[colx].field]) repGrid.showColumn(colx);
                //            else repGrid.hideColumn(colx);
                //        }

                //repGrid.setDataSource(repGrid.dataSource);
            }
        }

        function SetClientList(listDataSource, templateName) {
            /// <summary> Определение и обновление списка клиентов, дублирущего дерево при выборе
            /// узла дерева, соответствующего менеджеру</summary>
            $("#clientsView").kendoListView({
                dataSource: listDataSource,
                selectable: "single",
                change: listItemChange,
                template: kendo.template($("#" + templateName).html()) // clientListTmpl
            }).data("kendoListView");
        }

        function getOrValuesFltr(givenValues, attrName, isGuid) {
            var fltrArr = [];

            for (var step = 0, sLngth = givenValues.length; step < sLngth; step++)
                fltrArr[fltrArr.length] = (isGuid) ? _snglFltr_GuidEquals(attrName, givenValues[step]) : _snglFltr_NumberCompare(attrName, givenValues[step]);

            return fltrArr.join(' or ');
        }

        function nextSearchRes(e) {
            /// <summary> Поиск контракта по имени клиента.
            /// </summary>
            var searchAutocomp = $('#search_word').data('kendoAutoComplete');

            var clntsUids = GetAutoCompleteValue('search_word', searchAutocomp.value().split(searchAutocomp.options.separator), searchAutocomp.options, 'ContactId');

            var contrFltr = allRefs.contractsFltrDflt();
            contrFltr[contrFltr.length] = '(' + getOrValuesFltr(clntsUids, 'CustomerId/Id', true) + ')';

            ToggleListCard(true);

            var cntrctDataSource = new kendo.data.DataSource({
                transport: {
                    read: {
                        url: _getServerUrl() + "/XRMServices/2011/OrganizationData.svc/SalesOrderSet",
                        dataType: "json"
                    },
                    parameterMap: function (options) {
                        var parameter = {
                            $top: options.take,
                            $skip: options.skip,
                            $select: allRefs.contractsFlds(),
                            $filter: contrFltr.join(' and '),
                            $expand: allRefs.contractsJoin()
                        };
                        return parameter;
                    }
                },
                schema: {
                    parse: function (data) {
                        var retArray = [];

                        if (data.d && data.d.results && data.d.results.length > 0) {
                            var contrArray = data.d.results;

                            for (var took = 0, tLngth = contrArray.length; took < tLngth; took++) {

                                var dateSign = _dateReviver(0, contrArray[took]['mtr_date_signed']);

                                var stepContract = {};
                                stepContract.hasChildren = false;
                                stepContract.year = (dateSign) ? dateSign.getFullYear() : 2016;
                                stepContract.month = (dateSign) ? dateSign.getMonth() : 0;

                                for (var prop in contractModel) //
                                    stepContract[prop] = (prop in allRefs.dateAttr) ? _dateReviver(0, contrArray[took][contractModel[prop]]) :
                                        ObjFieldValue(prop, contrArray[took], contractModel);

                                if (contrArray[took][allRefs.joinOppr])
                                    for (var prop in opprtntModel)
                                        if (prop != 'Entity')
                                            stepContract[prop] = ObjFieldValue(prop, contrArray[took][allRefs.joinOppr], opprtntModel);

                                if (contrArray[took][allRefs.joinApps])
                                    for (var prop in appartModel)
                                        if (prop != 'Entity')
                                            stepContract[prop] = ObjFieldValue(prop, contrArray[took][allRefs.joinApps], appartModel);

                                if (contrArray[took][allRefs.joinPays] && contrArray[took][allRefs.joinPays].results &&
                                    contrArray[took][allRefs.joinPays].results.length > 0) {
                                    var paySum = 0;

                                    for (var loop = 0, lLngth = contrArray[took][allRefs.joinPays].results.length; loop < lLngth; loop++)
                                        paySum += GetParseNum(contrArray[took][allRefs.joinPays].results[loop][paysModel.urb_pay_sum].Value);

                                    stepContract['urb_pay_sum'] = paySum;
                                    stepContract['urb_pay_date'] = _dateReviver(0, contrArray[took][allRefs.joinPays].results[0][paysModel.urb_pay_date]);
                                }

                                stepContract['alert_color'] = ((_setOrDefault(GetParseNum(stepContract['urb_amount']), 0) - stepContract['urb_pay_sum']) > 1) ? 'red' : 'black';

                                retArray[retArray.length] = stepContract;
                            }
                        }

                        return retArray;
                    }
                }
            });

            SetClientList(cntrctDataSource, 'clientListTmpl');
        }

        function planItemDblClick() {
            /// <summary> Событие выбора элемента в списке PlansView двойным кликом
            /// </summary>
            if (selectedInList == null) return;

            var cData = $("#clientsView").data("kendoListView").dataSource.getByUid(selectedInList);

            if ('isTotal' in cData) return;

            _updateVisibl('stSquare' + selectedInList);
            _updateVisibl('inSquare' + selectedInList, true);
            _updateVisibl('stValue' + selectedInList);
            _updateVisibl('inValue' + selectedInList, true);
            _updateVisibl('stObjrate' + selectedInList);
            _updateVisibl('inObjrate' + selectedInList, true);

            updOrInitNumBox('squarepick' + selectedInList, lineSquareChange, (_setOrDefault(cData) != '') ? _setOrDefault(cData['planSquare'], null) : null);
            updOrInitNumBox('valuepick' + selectedInList, lineValueChange, (_setOrDefault(cData) != '') ? _setOrDefault(cData['planValue'], null) : null);
            updOrInitNumBox('objratepick' + selectedInList, lineObjrateChange, (_setOrDefault(cData) != '') ? _setOrDefault(cData['objRate'], null) : null);
        }

        function updOrInitNumBox(cntrlId, changeEvent, setValue) {
            var currNumBox = $("#" + cntrlId).data('kendoNumericTextBox');

            if (typeof currNumBox != 'undefined')
                currNumBox.value(_setOrDefault(setValue, null));
            else {
                $("#" + cntrlId).kendoNumericTextBox({
                    decimals: 2,
                    format: (~cntrlId.indexOf('objratepick')) ? '#.##' : '#',
                    change: changeEvent,
                    value: _setOrDefault(setValue, null)
                });
            }
        }

        function updLineCntrl(cntrlPref, recUid, newValue, exstFormat) {
            _setTextValue(cntrlPref + recUid,
                (_setOrDefault(newValue) != '') ? kendo.toString(newValue, exstFormat) : '');
        }

        function newRec2Plan(updtFld, recValue) {
            var formattedValue = (recValue == null) ? recValue :
                (updtFld == planningModel.urb_plan_amount) ?
                kendo.toString(recValue, '#.##########').replace(',', '.') : (updtFld == planningModel.urb_rsn_factor) ? kendo.toString(recValue, '#.##').replace(',', '.') : recValue ^ 0;

            var savedPlan = {};
            savedPlan[updtFld] = formattedValue;

            return savedPlan;
        }

        function lineValueUpdate(recValue, updtFld, recUid, datName) {
            var clntsData = $("#clientsView").data("kendoListView").dataSource,
                clntTree = $('#treeview').data('kendoTreeView');

            var recData = clntsData.getByUid(recUid);
            recData[datName] = _setOrDefault(recValue);

            var nodeData = clntTree.dataItem(clntTree.select()),
                viewData = clntsData.data(); // текущие записи для обновления данных менеджеров

            writeLineChanges(newRec2Plan(updtFld, recValue), nodeData, recData);

            var sumTotal = 0, lineCount = 0;

            for (var step = 0, sLngth = viewData.length; step < sLngth; step++)
                if (viewData[step]['objUid'] == recData['objUid'] && _setOrDefault(viewData[step]['manUid']) != '' && recData.uid != viewData[step].uid) {
                    sumTotal += _setOrDefault(GetParseNum(viewData[step][datName]), 0);
                    lineCount++;
                }

            if (_setOrDefault(recData['manUid']) == '' && ((recValue > 0 && sumTotal == 0) || (_setOrDefault(recValue, 0) == 0 && sumTotal > 0))) {
                var newTotal = (recValue > 0) ? recValue * 10 / 9 : 0;
                var newLineValue = (newTotal > 0) ? newTotal / lineCount : 0;

                for (var step = 0, sLngth = viewData.length; step < sLngth; step++)
                    if (viewData[step]['objUid'] == recData['objUid']) {

                        if (_setOrDefault(viewData[step]['manUid']) != '')
                            writeLineChanges(newRec2Plan(updtFld, newLineValue), nodeData, viewData[step]);

                        if (_setOrDefault(viewData[step]['manUid']) != '' || 'isTotal' in viewData[step]) {
                            viewData[step][datName] = _setOrDefault(('isTotal' in viewData[step]) ? newTotal : newLineValue);
                            updLineCntrl(datName.replace('plan', 'st'), viewData[step].uid,
                                ('isTotal' in viewData[step]) ? newTotal : newLineValue, (~datName.indexOf('Value')) ? 'c' : '0');
                        }

                        if ('isTotal' in viewData[step]) {
                            var insrtStr = '(ОТ ';
                            var sHdrElem = _getElemById(datName.replace('plan', 'dt') + viewData[step].uid);

                            if (sHdrElem != null)
                                sHdrElem.innerText = sHdrElem.innerText.substr(0, sHdrElem.innerText.indexOf(insrtStr)) + insrtStr +
                                    kendo.toString(newTotal, 'n0') + ')';
                        }
                    }
            }
            else if (_setOrDefault(recData['manUid']) != '')
                for (var step = 0, sLngth = viewData.length; step < sLngth; step++)
                    if (viewData[step]['objUid'] == recData['objUid'] && 'isTotal' in viewData[step]) {
                        updLineCntrl(datName.replace('plan', 'st'), viewData[step].uid,
                                sumTotal + recValue, (~datName.indexOf('Value')) ? 'c' : '0');
                    }
            if (datName == 'objRate')
                updLineCntrl('stObjrate', recUid, recValue, '0.00');
            else
                updLineCntrl(datName.replace('plan', 'st'), recUid, recValue, (~datName.indexOf('Value')) ? 'c' : '0');
        }

        function writeLineChanges(writeRec, nodeData, recData) {
            if (typeof recData['planUid'] == 'undefined' || recData['planUid'] == '')
                allRefs.addPlanRec(nodeData.year, nodeData.month, writeRec, recData);
            else
                _updateAjax(_getServerUrl(), planningModel['Entity'], recData['planUid'], writeRec);

            if (planningModel.urb_Id in writeRec && !('planUid' in recData))
                recData['planUid'] = writeRec[planningModel.urb_Id];
            else if (!(planningModel.urb_Id in writeRec) && 'planUid' in recData)
                writeRec[planningModel.urb_Id] = recData['planUid'];

            allRefs.planningsRef(nodeData.year, allRefs.defaults.periods, nodeData.month, writeRec);
        }

        function lineSquareChange() {
            var recUid = this.element[0].id.replace('squarepick', '');

            lineValueUpdate(this.value(), planningModel.urb_plan_square, recUid, 'planSquare');
        }

        function lineValueChange() {
            var recUid = this.element[0].id.replace('valuepick', '');

            lineValueUpdate(this.value(), planningModel.urb_plan_amount, recUid, 'planValue');
        }

        function lineObjrateChange() {
            var recUid = this.element[0].id.replace('objratepick', '');

            lineValueUpdate(this.value(), planningModel.urb_rsn_factor, recUid, 'objRate');
        }

        function listItemChange() {
            /// <summary> Событие смены выбранного объекта
            /// </summary>
            var selUid = _setOrDefault(selectedInList);

            var cData = $("#clientsView").data("kendoListView").dataSource.view(),
                selected = $.map(this.select(), function (item) {
                    return cData[$(item).index()].uid;
                });

            var tmpSelect = (selected.length > 0) ? selected[0] : null;
            
            if (selUid != '' && selUid != tmpSelect) {
                var vDatCntrl = 'stactdate' + selUid,
                    inpDatCntrl = 'inactdate' + selUid,
                    vSqrCntrl = 'stSquare' + selUid,
                    inpSqrCntrl = 'inSquare' + selUid,
                    vValCntrl = 'stValue' + selUid,
                    inpValCntrl = 'inValue' + selUid,
                    vRateCntrl = 'stObjrate' + selUid,
                    inpRateCntrl = 'inObjrate' + selUid,
                    actDateHead = 'actdatehdr' + selUid;

                _updateVisibl(vDatCntrl, true);
                _updateVisibl(inpDatCntrl);
                _updateVisibl(vSqrCntrl, true);
                _updateVisibl(inpSqrCntrl);
                _updateVisibl(vValCntrl, true);
                _updateVisibl(inpValCntrl);
                _updateVisibl(vRateCntrl, true);
                _updateVisibl(inpRateCntrl);
                _setTextValue(actDateHead, '');
            }

            selectedInList = tmpSelect;
        }

        function actListDblClick() {
            /// <summary> Событие выбора элемента в списке ListView двойным кликом
            /// </summary>
            if (selectedInList == null) return;

            var invCntrl = 'stactdate' + selectedInList,
                dateCntrl = 'inactdate' + selectedInList,
                datePicker = 'datepick' + selectedInList,
                actDateHead = 'actdatehdr' + selectedInList;

            _updateVisibl(invCntrl);
            _updateVisibl(dateCntrl, true);
            _setTextValue(actDateHead, 'дата акта');

            var cData = $("#clientsView").data("kendoListView").dataSource.getByUid(selectedInList);

            var actDate = (_setOrDefault(cData) != '') ? _setOrDefault(cData['urb_act1_date'], null) : null;

            var pickerCntrl = $('#' + datePicker).data('kendoDatePicker');

            if (typeof pickerCntrl != 'undefined') {
                pickerCntrl.value(actDate);
            }
            else {
                $('#' + datePicker).kendoDatePicker({
                    format: "dd.MM.yyyy",
                    culture: "ru-RU",
                    max: new Date(),
                    change: actDateChange,
                    value: actDate
                });
            }
        }

        function actDateChange() {
            var selDat = this.value();
            var updtFld = 'urb_act1_date';
            var agreeUid = this.element[0].id.replace('datepick', '');

            var cData = $("#clientsView").data("kendoListView").dataSource.getByUid(agreeUid);

            if (_setOrDefault(cData) != '') {
                var contractUid = _setOrDefault(cData['urb_Id']);

                if (contractUid == '')
                    return;

                var saveContract = {};
                saveContract[contractModel[updtFld]] = selDat;

                _updateAjax(_getServerUrl(), contractModel['Entity'], contractUid, saveContract);

                cData[updtFld] = _setOrDefault(selDat);

                var invCntrl = 'stactdate' + agreeUid,
                    actDateHead = 'actdatehdr' + agreeUid;

                _setTextValue(actDateHead, (_setOrDefault(selDat) != '') ? 'дата акта' : '');
                _setTextValue(invCntrl, (_setOrDefault(selDat) != '') ? selDat.toLocaleDateString() : '');
            }
        }

        function ToggleListCard(switchListView) {
            //_updateVisibl("saleCard", !switchListView);
            _updateVisibl("clientsView", switchListView);
            _updateVisibl('reportGrid', !switchListView);
        }

        function SetAppsList(listDataSource) {
            /// <summary> Определение и обновление представления строк акта
            /// </summary>
            $("#appsView").kendoListView({
                dataSource: listDataSource,
                selectable: "single",
                change: appItemChange,
                template: kendo.template($("#appsListTmpl").html()),
                editTemplate: kendo.template($("#appsListEditTmpl").html())
            }).data("kendoListView");
        }

        function SetPaysList(listDataSource) {
            /// <summary> Определение и обновление представления строк платежей
            /// </summary>
            $("#paysView").kendoListView({
                dataSource: listDataSource,
                selectable: "single",
                change: appItemChange,
                template: kendo.template($("#paysListTmpl").html())
            }).data("kendoListView");
        }

        function SetAppsDataSrc(dataArray) {
            var appFields = {};

            for (var prop in actrecModel) {
                appFields[prop] = {};
                appFields[prop]['type'] = (~prop.indexOf('sum')) ? 'number' : (~prop.indexOf('date')) ? 'date' : 'string';
            }

            return {
                data: dataArray,
                schema: {
                    model: {
                        id: 'urb_Id',
                        fields: appFields
                    }
                },
                change: function (e) {
                    var data = this.data();
                    var testStrc = data.length;
                }
            };
        }

        function appItemChange() {
            /// <summary> Событие смены выбранного помещения
            /// </summary>
            var cData = $("#appsView").data("kendoListView").dataSource.view(),
                selected = $.map(this.select(), function (item) {
                    return cData[$(item).index()].uid;
                });
            selectedAppId = (selected.length > 0) ? selected.join(";") : null; // выбор множественный - массив преобразуется в строку с разделителем в виде ";"
        }

        function UpdateTreeViewSelect(selectUid, scrollOffset) {
            /// <summary> Программное обновление выбора клиента в дереве с фокусированием
            /// </summary>
            var treeView = $("#treeview").data("kendoTreeView");

            treeView.select(treeView.findByUid(selectUid));

            var rootOffset = (scrollOffset) ? scrollOffset : treeView.findByUid(treeView.parent(treeView.select()).data().uid)[0].offsetTop;

            $("#treeview").animate({ scrollTop: (rootOffset + treeView.select()[0].offsetTop) });
        }

        function EnableTreeView(isEnabled) {
            var treeView = $('#treeview').data('kendoTreeView');

            treeview.enable((isEnabled) ? '.k-item' : treeview.findByText('none'));
        }

        function saveClientRec() {
            saveClient = {};

            var treeView = $('#treeview').data("kendoTreeView");

            var selectedNode = (treeView && treeView.select() && treeView.select().data()) ? treeView.dataSource.getByUid(treeView.select().data().uid) : null;

            if (selectedNode == null) return;

            var clientId = (selectedNode.urb_lead != null && selectedNode.urb_lead.Id != null) ? selectedNode.urb_lead.Id : null;

            var recordId = selectedNode.urb_Id;

            for (var prop in leadClientModel) {
                var propEditCntrl = FieldEditControl(prop);
                var xValFld = _getElemById(prop),
                    newValFld = _getElemById(UpdateCntrlName(prop));

                if (newValFld == null) continue;

                var xFieldValue = _getCheckVal(prop, xValFld.innerText);
                var newPropValue = (propEditCntrl) ? propEditCntrl.value() : newValFld.value;

                if (prop in allRefs.required && newPropValue == '') {
                    $('#' + prop + '_ent').css({ border: '0 solid #f37736' }).animate({ borderWidth: 4 }, 500);
                    $('#' + prop + '_ent').keypress(function () { $(this).css({ border: '' }) });
                    return;
                }

                if (xValFld == null || xFieldValue == newPropValue) continue;

                if (leadClientModel[prop] in allRefs.partySave) {
                    var partyFlds = allRefs.partySave[leadClientModel[prop]].split(';'),
                        partyVals = newPropValue.split(' ');

                    for (var step = 0, sLngth = partyFlds.length; step < sLngth; step++)
                        if (step < (sLngth - 1) && partyVals.length > step)
                            saveClient[partyFlds[step]] = partyVals[step];
                        else if (step == (sLngth - 1) && partyVals.length > step)
                            saveClient[partyFlds[step]] = partyVals.slice(step).join(' ');
                }
                else if (prop in allRefs.optsAttr) {
                    saveClient[leadClientModel[prop]] = {};
                    saveClient[leadClientModel[prop]].Value = (newPropValue != '') ? newPropValue : null;
                }
                else
                    saveClient[leadClientModel[prop]] = newPropValue;
            }

            var selUid = selectedNode.uid;
            var selNode = selectedNode;

            var newAttrs = 0;
            for (var prop in saveClient) newAttrs++;

            if (newAttrs > 0) {
                var leadData = null;

                if (clientId == null) leadData = _createAjax(_getServerUrl(), leadClientModel['Entity'], saveClient);
                else {
                    _updateAjax(_getServerUrl(), leadClientModel['Entity'], clientId, saveClient);
                    leadData = _syncAjax(_getServerUrl(), leadClientModel['Entity'], _objectUrbSelect(leadClientModel), _snglFltr_GuidEquals(leadClientModel['Entity'] + 'Id', clientId));
                }

                if (leadData.d && leadData.d[leadClientModel['Entity'] + 'Id']) {
                    var newClientId = leadData.d[leadClientModel['Entity'] + 'Id'];
                    var manNode = treeView.dataSource.getByUid(treeView.parent(treeView.select()).data().uid);

                    treeView.expand(treeView.findByUid(manNode.uid));

                    var newClient = {};

                    for (var prop in leadClientModel)
                        newClient[prop] = ObjFieldValue(prop, leadData.d, leadClientModel);

                    var selIndx = null;

                    for (var step = 0, sLngth = manNode.Clients.length; step < sLngth; step++)
                        if (manNode.Clients[step].urb_Id.trim() == recordId) {
                            selIndx = step;
                            break;
                        }

                    manNode.Clients.splice(selIndx, 1, newClient);

                    selUid = manNode.children.data()[selIndx].uid;
                    selNode = manNode.children.data()[selIndx];
                }
            }

            UpdateTreeViewSelect(selUid);
            ViewCardForm(selNode);
        }

        function ViewCardForm(nodeData, enterMode) {
            /// <summary> Включение режима отображения карточки выбранного клиента
            /// </summary>
            ToggleListCard();

            SetClientList();

            _updateVisibl('save_client', enterMode);

            for (var prop in contractModel) {
                var viewControl = _getElemById(prop),
                    updtControl = _getElemById(prop + '_block');

                if (viewControl && updtControl) {
                    _updateVisibl(prop, !enterMode);
                    _updateVisibl(prop + '_block', enterMode);
                }

                ObjFieldSetControl(prop, nodeData[prop]);
                ObjFieldSetControl(prop, nodeData[prop], true);

                if (enterMode) $('#' + prop + '_ent').css({ border: '' });
                else if (prop in allRefs.mailAttr && nodeData[prop] != '')
                    _getElemById(prop).innerHTML = '<a href="mailto:' + nodeData[prop] +
                        ((allRefs.mailAttr[prop] != '') ? '?Subject=' + allRefs.mailAttr[prop] : '') + '" target="_top">' + nodeData[prop] + '</a>';
            }

            var actsSlct = allRefs.acts(nodeData.year, nodeData.month, nodeData.urb_Id);

            var paysSlct = allRefs.mnthPayments(nodeData.year, nodeData.month, nodeData.urb_Id);

            if (actsSlct.length == 0) {
                var addedAct = allRefs.addNewAct(nodeData.year, nodeData.month, nodeData.urb_Id, false);
                if (addedAct) actsSlct[0] = allRefs._parseActs([addedAct]);
            }

            var actId = (actsSlct.length > 0) ? actsSlct[0]['urb_Id'] : '';

            if (actsSlct.length > 0) {
                var numAttr = 'urb_number',
                    sqrAttr = 'urb_square';

                actsSlct[0]['urb_start'] = new Date(nodeData.year, nodeData.month - 1, 1, 0, 0, 1);
                actsSlct[0]['urb_finish'] = new Date(nodeData.year, nodeData.month, 0, 23, 59, 59);

                for (var step = 0, sLngth = paysSlct.length; step < sLngth; step++) {
                    var cntrctNum = paysSlct[step][transModel[numAttr]];
                    var findFlg = false;

                    for (var loop = 0, lLngth = actsSlct[0][allRefs.joinPref].length; loop < lLngth; loop++)
                        if (cntrctNum == actsSlct[0][allRefs.joinPref][loop][numAttr]) {
                            actsSlct[0][allRefs.joinPref][loop][sqrAttr] = paysSlct[step][transModel[sqrAttr]];

                            findFlg = true;
                            break;
                        }

                    if (!findFlg)
                        actsSlct[0][allRefs.joinPref][actsSlct[0][allRefs.joinPref].length] = GetModelObject(transModel, paysSlct[step]);

                }

                if (actsSlct[0][allRefs.joinPref] && actsSlct[0][allRefs.joinPref].length > 0) {
                    var actTotals = allRefs.getTotals(actsSlct[0][allRefs.joinPref]);

                    for (var prop in actTotals)
                        actsSlct[0][prop] = actTotals[prop];
                }

                for (var prop in actModel) _setTextValue(prop, actsSlct[0][prop]);

                _setTextValue('urb_sum', kendo.toString(actsSlct[0]['urb_sum'], 'c'))

                SetAppsList(SetAppsDataSrc(actsSlct[0][allRefs.joinPref]));
                if (actsSlct[0][allRefs.joinPref].length > 0)
                    _setTextValue('lookupCount', actsSlct[0][allRefs.joinPref].length);

                if (actsSlct[0]['urb_isquart']) {
                    if (nodeData.urb_template && ~nodeData.urb_template.indexOf('.docx'))
                        actsSlct[0]['url'] = nodeData.urb_template.replace('.docx', '_sqr.docx');

                    actsSlct[0]['sqr_start'] = new Date(nodeData.year, nodeData.month - 3, 1, 0, 0, 1);

                    var paysSqrSlct = allRefs.payments(actsSlct[0]['sqr_start'], actsSlct[0]['urb_finish'], nodeData.urb_Id);

                    if (paysSqrSlct.length > 0) {
                        actsSlct[0]['quarter_recs'] = [];

                        for (var step = 0, sLngth = paysSqrSlct.length; step < sLngth; step++)
                            if (GetParseNum(paysSqrSlct[step]['urb_sum']) > 0)
                                actsSlct[0]['quarter_recs'][actsSlct[0]['quarter_recs'].length] = GetModelObject(transModel, paysSqrSlct[step]);

                        var quartTotals = allRefs.getTotals(actsSlct[0]['quarter_recs']);

                        for (var prop in actTotals)
                            actsSlct[0][prop + '_quart'] = quartTotals[prop];
                    }
                    SetPaysList(actsSlct[0]['quarter_recs']);
                }
                else {
                    SetPaysList(paysSlct);
                    actsSlct[0]['url'] = nodeData.urb_template;
                }

                selectedAct = actsSlct[0];

                if (_getElemById('urb_isquart'))
                    _getElemById('urb_isquart').checked = selectedAct['urb_isquart'];
            }

            if (nodeData.urb_template && nodeData.urb_template.length > 0)
                tmplBlob2Base(_getActualSPLink(selectedAct['url']));

            var historicData = new kendo.data.DataSource({
                schema: {
                    data: function (data) { return allRefs.actsHistory(nodeData.urb_Id, actId); }
                }
            });

            var histCont = 'actsView';

            var clntsSubView = $('#' + histCont).kendoListView({
                dataSource: historicData,
                template: kendo.template($('#historyTmpl').html())
            }).data('kendoListView');

            var actsView = _getElemById(histCont);
            var histRecsLngth = historicData.data().length;

            _setTextValue('urb_histrecs', RecsDeclention(histRecsLngth));

            if (actsView) actsView.style.height = (histRecsLngth * 33) + 'px';
        }

        function RecsDeclention(countRecs) {
            /// <summary> Процедура выбора склоненного варианта слова "запись" в зависимости от числа.
            /// </summary>
            var sCapt = 'запись', vCapt = 'записи', tCapt = 'записей';

            if (countRecs === null || countRecs === 0) return 'отсутствуют';

            var tempStr = countRecs.toString();
            var tempPostf = (tempStr == '1' || (tempStr.length > 1 && tempStr[tempStr.length - 1] == '1' && tempStr.substring(tempStr.length - 2) != '11')) ? sCapt :
                (parseInt(tempStr) > 1 && parseInt(tempStr) < 5 || (tempStr.length > 1 && parseInt(tempStr[tempStr.length - 1]) > 1 && parseInt(tempStr[tempStr.length - 1]) < 5 && tempStr[tempStr.length - 2] != '1')) ? vCapt : tCapt;

            return tempStr + ' ' + tempPostf;
        }

        function ResizeSplitter() {
            /// <summary>Принудительное форматирование вертикального сплиттера
            /// в соответствии с исходными настройками - можно использовать для возврата
            /// вида областей в исходное состояние без перезагрузки страницы</summary>
            var horisSpl = $("#vertical").data("kendoSplitter");
            if (horisSpl == null) return;
            horisSpl.size('#top_pane', '30px');
            horisSpl.trigger('resize');
            horisSpl.size('#top_pane', '31px');
            horisSpl.size('#bottom_pane', '100%');
            horisSpl.trigger('resize');
        }

        function number_to_string(_number) {
            var _arr_numbers = new Array();
            _arr_numbers[1] = new Array('', 'один', 'два', 'три', 'четыре', 'пять', 'шесть', 'семь', 'восемь', 'девять', 'десять', 'одиннадцать', 'двенадцать', 'тринадцать', 'четырнадцать', 'пятнадцать', 'шестнадцать', 'семнадцать', 'восемнадцать', 'девятнадцать');
            _arr_numbers[2] = new Array('', '', 'двадцать', 'тридцать', 'сорок', 'пятьдесят', 'шестьдесят', 'семьдесят', 'восемьдесят', 'девяносто');
            _arr_numbers[3] = new Array('', 'сто', 'двести', 'триста', 'четыреста', 'пятьсот', 'шестьсот', 'семьсот', 'восемьсот', 'девятьсот');
            function number_parser(_num, _desc) {
                var _string = '';
                var _num_hundred = '';
                if (_num.length == 3) {
                    _num_hundred = _num.substr(0, 1);
                    _num = _num.substr(1, 3);
                    _string = _arr_numbers[3][_num_hundred] + ' ';
                }
                if (_num < 20) _string += _arr_numbers[1][parseFloat(_num)] + ' ';
                else {
                    var _first_num = _num.substr(0, 1);
                    var _second_num = _num.substr(1, 2);
                    _string += _arr_numbers[2][_first_num] + ' ' + _arr_numbers[1][_second_num] + ' ';
                }
                switch (_desc) {
                    case 0:
                        var _last_num = parseFloat(_num.substr(-1));
                        if (_last_num == 1) _string += 'рубль';
                        else if (_last_num > 1 && _last_num < 5) _string += 'рубля';
                        else _string += 'рублей';
                        break;
                    case 1:
                        var _last_num = parseFloat(_num.substr(-1));
                        if (_last_num == 1) _string += 'тысяча ';
                        else if (_last_num > 1 && _last_num < 5) _string += 'тысячи ';
                        else _string += 'тысяч ';
                        _string = _string.replace('один ', 'одна ');
                        _string = _string.replace('два ', 'две ');
                        break;
                    case 2:
                        var _last_num = parseFloat(_num.substr(-1));
                        if (_last_num == 1) _string += 'миллион ';
                        else if (_last_num > 1 && _last_num < 5) _string += 'миллиона ';
                        else _string += 'миллионов ';
                        break;
                    case 3:
                        var _last_num = parseFloat(_num.substr(-1));
                        if (_last_num == 1) _string += 'миллиард ';
                        else if (_last_num > 1 && _last_num < 5) _string += 'миллиарда ';
                        else _string += 'миллиардов ';
                        break;
                }
                _string = _string.replace('  ', ' ');
                return _string;
            }
            function decimals_parser(_num) {
                var _first_num = _num.substr(0, 1);
                var _second_num = parseFloat(_num.substr(1, 2));
                var _string = ' ' + _first_num + _second_num;
                if (_second_num == 1) _string += ' копейка';
                else if (_second_num > 1 && _second_num < 5) _string += ' копейки';
                else _string += ' копеек';
                return _string;
            }
            if (!_number || _number == 0) return false;
            if (typeof _number !== 'number') {
                _number = _number.replace(',', '.');
                _number = parseFloat(_number);
                if (isNaN(_number)) return false;
            }
            _number = _number.toFixed(2);
            if (_number.indexOf('.') != -1) {
                var _number_arr = _number.split('.');
                var _number = _number_arr[0];
                var _number_decimals = _number_arr[1];
            }
            var _number_length = _number.length;
            var _string = '';
            var _num_parser = '';
            var _count = 0;
            for (var _p = (_number_length - 1) ; _p >= 0; _p--) {
                var _num_digit = _number.substr(_p, 1);
                _num_parser = _num_digit + _num_parser;
                if ((_num_parser.length == 3 || _p == 0) && !isNaN(parseFloat(_num_parser))) {
                    _string = number_parser(_num_parser, _count) + _string;
                    _num_parser = '';
                    _count++;
                }
            }
            if (_number_decimals) _string += decimals_parser(_number_decimals);
            return _string.charAt(0).toUpperCase() + _string.substring(1);
        }

        FixSize();

        var selectedInList = null;
        var selectedAppId = null;
    </script>
    <style>
        .cust-view {
            float: left;
            width: 100%;
            height: 60px;
            box-sizing: border-box;
            border-top: 0;
            position: relative;
        }

            .cust-view:nth-child(even) {
                border-left-width: 0;
            }

            .cust-view dl {
                margin: 3px 5px 0;
                padding: 0;
                overflow: hidden;
            }

            .cust-view hd, dt, dd {
                float: left;
                margin: 0;
                margin-bottom: 6px;
                padding: 0;
                line-height: 23px;
                font-size: 18px;
            }

            .cust-view dt {
                font-size: 11px;
                height: 14px;
                width: 12%;
                line-height: 14px;
                text-transform: uppercase;
                text-align: right;
                padding-right: 5px;
                opacity: 0.7;
            }

            .cust-view dd {
                height: 28px;
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
            }

            .cust-view hd {
                float: left;
                width: 100%;
                height: 27px;
                overflow: hidden;
                white-space: nowrap;
                text-overflow: ellipsis;
            }

        .k-listview {
            border-width: 1px 0 0;
            padding: 0;
            overflow: hidden;
            min-height: 298px;
        }

        .edit-buttons {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            text-align: right;
            padding: 3px;
            background-color: rgba(0,0,0,0.1);
        }

        .k-pager-wrap {
            border-top: 0;
        }

        span.k-invalid-msg {
            position: absolute;
            margin-left: 6px;
        }

        .k-add-button {
            margin-bottom: 2em;
        }

        @media only screen and (max-width : 620px) {
            .cust-view {
                width: 100%;
            }

                .cust-view:nth-child(even) {
                    border-left-width: 1px;
                }
        }

        input[type=text]::-ms-clear {
            display: none;
        }
    </style>
</body>

</html>
